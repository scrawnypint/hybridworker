<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hybrid Work Planner</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
        }

        .day-cell {
            transition: all 0.15s ease-out;
        }

        .day-cell:hover:not(.disabled) {
            transform: scale(1.15);
            z-index: 10;
            cursor: pointer;
        }

        .year-select {
            background: transparent;
            border: none;
            color: inherit;
            font-weight: inherit;
            font-size: inherit;
            cursor: pointer;
            border-bottom: 2px solid #bfdbfe;
            padding: 0 0.2em;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
        }

        .year-select:hover {
            border-bottom-color: #60a5fa;
        }

        .year-select:focus {
            background-color: #eff6ff;
            border-radius: 4px;
        }

        #calendar-app {
            display: none;
        }

        #loading-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 24px 32px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }

        #google-auth-btn:disabled,
        #microsoft-auth-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        #google-auth-btn:not(:disabled):hover,
        #microsoft-auth-btn:not(:disabled):hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        #cloud-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        #cloud-status.saving {
            background: #dbeafe;
            color: #1e40af;
        }

        #cloud-status.saved {
            background: #dcfce7;
            color: #166534;
        }

        #cloud-status.error {
            background: #fee2e2;
            color: #991b1b;
        }

        #cloud-status.loading {
            background: #f3f4f6;
            color: #6b7280;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .cloud-saving {
            animation: pulse 1s infinite;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

<!-- Loading indicator -->
<div id="loading-indicator">
    <div class="text-center">
        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
        </svg>
        <p class="text-sm text-slate-600" id="loading-text">Loading data...</p>
    </div>
</div>

<!-- Auth screen -->
<div id="auth-screen" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-xl shadow-2xl border border-slate-200">
    <h2 class="text-3xl font-bold text-blue-800 mb-2 text-center" id="auth-title">Sign in</h2>
    <p class="text-slate-500 text-sm text-center mb-6">Your calendar will be saved in the cloud</p>

    <div id="auth-error" class="text-red-600 mb-4 text-center hidden p-3 bg-red-50 rounded-lg border border-red-200"></div>

    <input type="email" id="auth-email" placeholder="Email address"
           class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
    <input type="password" id="auth-password" placeholder="Password"
           class="w-full p-3 mb-6 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">

    <button id="auth-main-btn" onclick="handleAuth()"
            class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        Sign in
    </button>

    <p class="text-center mt-3 text-xs">
        <button type="button" onclick="openResetScreen()" class="text-blue-500 hover:text-blue-700 underline">
            Forgot your password?
        </button>
    </p>

    <div class="mt-4 flex items-center justify-center">
        <div class="w-full border-t border-slate-200"></div>
        <div class="px-3 text-sm text-slate-400">OR</div>
        <div class="w-full border-t border-slate-200"></div>
    </div>

    <button id="google-auth-btn" onclick="signInWithGoogle()"
            class="w-full py-3 mt-4 flex items-center justify-center bg-white text-slate-700 font-semibold rounded-lg border border-slate-300 hover:bg-slate-50 transition shadow-sm">
        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335"
                  d="M24 9.5c3.54 0 6.71 1.22 9.21 3.4l6.62-6.5C34.33 3.6 29.47 2 24 2 15.3 2 7.76 6.13 3.96 12.55l7.98 6.19C13.25 14.54 18.06 9.5 24 9.5z"/>
            <path fill="#4285F4"
                  d="M46.5 24c0-1.64-.15-3.22-.42-4.74H24v9.49h12.7c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6C43.64 38.48 46.5 31.77 46.5 24z"/>
            <path fill="#FBBC05"
                  d="M11.94 28.34c-.63-1.87-.99-3.86-.99-5.91s.36-4.04.99-5.91L3.96 10.33C1.96 14.16 1 18.41 1 23c0 4.59.96 8.84 2.96 12.67l7.98-7.33z"/>
            <path fill="#34A853"
                  d="M24 47c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 40.53 14.54 47 24 47z"/>
        </svg>
        <span id="google-btn-text">Sign in with Google</span>
    </button>

    <button id="microsoft-auth-btn" onclick="signInWithMicrosoft()"
            class="w-full py-3 mt-3 flex items-center justify-center bg-white text-slate-700 font-semibold rounded-lg border border-slate-300 hover:bg-slate-50 transition shadow-sm">
        <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" width="10" height="10" fill="#F25022"></rect>
            <rect x="13" y="1" width="10" height="10" fill="#7FBA00"></rect>
            <rect x="1" y="13" width="10" height="10" fill="#00A4EF"></rect>
            <rect x="13" y="13" width="10" height="10" fill="#FFB900"></rect>
        </svg>
        <span id="microsoft-btn-text">Sign in with Microsoft</span>
    </button>

    <p class="text-center mt-6 text-sm">
        <button id="auth-toggle-btn" onclick="toggleAuthMode()"
                class="text-blue-500 hover:text-blue-700 font-medium">
            Don't have an account? Register!
        </button>
    </p>
</div>

<!-- Password reset screen -->
<div id="reset-screen" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-xl shadow-2xl border border-slate-200 hidden">
    <h2 class="text-3xl font-bold text-blue-800 mb-2 text-center">Reset password</h2>
    <p class="text-slate-500 text-sm text-center mb-6">
        Enter your email address and we will send you a link to reset your password.
    </p>

    <div id="reset-error" class="text-red-600 mb-3 text-center hidden p-3 bg-red-50 rounded-lg border border-red-200"></div>
    <div id="reset-info" class="text-green-700 mb-3 text-center hidden p-3 bg-green-50 rounded-lg border border-green-200"></div>

    <input type="email" id="reset-email" placeholder="Email address"
           class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">

    <button type="button" onclick="submitPasswordReset()"
            class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        Send reset link
    </button>

    <p class="text-center mt-4 text-sm">
        <button type="button" onclick="backToSignIn()"
                class="text-blue-500 hover:text-blue-700 font-medium">
            Back to sign in
        </button>
    </p>
</div>

<!-- Calendar app -->
<div id="calendar-app" class="max-w-7xl mx-auto">
    <header class="mb-8 text-center">
        <div class="flex justify-center items-center gap-3 mb-2 flex-wrap">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 flex items-center gap-2 flex-wrap justify-center"
                id="main-title">
                Hybrid Work Planner
                <div class="relative inline-block">
                    <select id="year-selector" onchange="changeYear(this.value)" class="year-select text-blue-600">
                    </select>
                </div>
            </h1>
        </div>
        
        <!-- User & sync status -->
        <div class="flex justify-center items-center gap-3 mb-4 flex-wrap">
            <span class="text-slate-500 text-sm" id="user-email-display"></span>
            <div id="cloud-status" class="saved">
                <span id="cloud-icon">‚òÅÔ∏è</span>
                <span id="cloud-text">Saved</span>
            </div>
        </div>

        <p class="text-slate-600 mb-4 flex justify-center items-center gap-3 flex-wrap">
            <span class="flex items-center gap-2">
                Goal:
                <span class="relative inline-block">
                    <select id="target-selector" onchange="changeTarget(this.value)"
                            class="appearance-none font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-200 hover:border-blue-400 cursor-pointer focus:outline-none focus:bg-blue-100 rounded px-2 py-0.5 text-center transition-all pr-6">
                    </select>
                    <span class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400 text-xs">‚ñº</span>
                </span>
                days in the office.
            </span>

            <span class="flex items-center gap-2">
                Vacation:
                <input id="vacation-limit-input"
                       type="number"
                       min="0"
                       step="1"
                       onchange="changeVacationLimit(this.value)"
                       class="w-20 text-center font-bold text-amber-600 bg-amber-50 border-b-2 border-amber-200 hover:border-amber-400 focus:outline-none focus:bg-amber-100 rounded px-2 py-0.5 text-sm"
                       placeholder="e.g. 26">
                days
            </span>
        </p>

        <div class="flex flex-wrap justify-center gap-4 text-sm bg-white p-3 rounded-xl shadow-sm inline-flex">
            <div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Office</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-amber-400 rounded mr-2"></div>Vacation</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-rose-400 rounded mr-2"></div>Sick leave</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>Remote work</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-slate-100 border border-slate-200 rounded mr-2"></div>Weekend</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-red-100 border border-red-200 rounded mr-2"></div>Public holiday</div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">To work</div>
                <div class="text-xl font-bold text-slate-700" id="year-working-days">0</div>
                <div class="text-xs text-slate-400 font-normal">(after absences)</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Target (<span id="summary-target-label">40%</span>)</div>
                <div class="text-xl font-bold text-blue-600" id="year-required-days">0</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">In the office</div>
                <div class="text-xl font-bold text-green-600" id="year-selected-days">0</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Absences</div>
                <div class="text-xl font-bold text-amber-600" id="year-absence-days">0</div>
                <div class="text-xs text-slate-400 font-normal">
                    <span id="vacation-count">0</span> vacation / <span id="sick-count">0</span> sick leave
                </div>
            </div>
        </div>

        <div class="mt-4 text-sm text-slate-400 text-center flex flex-wrap justify-center gap-4">
            <button onclick="clearAll()" class="text-red-400 hover:text-red-600 underline text-xs">
                üóëÔ∏è Reset year <span class="current-year-display"></span>
            </button>
            <button onclick="signOutUser()" class="text-slate-400 hover:text-slate-600 underline text-xs">
                üö™ Sign out
            </button>
        </div>
    </header>

    <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"></div>

    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
        ‚òÅÔ∏è Your data is automatically saved in Firebase Cloud.<br>
        When you sign in again, you will see your calendar in its last saved state.
    </footer>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import {
        getAuth,
        onAuthStateChanged,
        signInWithEmailAndPassword,
        createUserWithEmailAndPassword,
        signOut,
        GoogleAuthProvider,
        OAuthProvider,
        signInWithPopup,
        signInWithRedirect,
        getRedirectResult,
        sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import {
        getFirestore,
        doc,
        getDoc,
        setDoc
    } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
        apiKey: "AIzaSyAV5MvDejW_cefwyx-ZeBKqWcjUveyYEs0",
        authDomain: "hybridworker.firebaseapp.com",
        projectId: "hybridworker",
        storageBucket: "hybridworker.firebasestorage.app",
        messagingSenderId: "1077197503232",
        appId: "1:1077197503232:web:e22cf7b58264024bb051e5",
        measurementId: "G-T8T1JM3RMS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const googleProvider = new GoogleAuthProvider();
    googleProvider.addScope('email');
    googleProvider.addScope('profile');
    googleProvider.setCustomParameters({ prompt: 'select_account' });

    // Microsoft provider (Azure AD / Microsoft 365)
    const microsoftProvider = new OAuthProvider('microsoft.com');
    microsoftProvider.setCustomParameters({ prompt: 'select_account' });
    microsoftProvider.addScope('User.Read');

    // --- CONSTANTS & STATE ---
    const MIN_YEAR = 2025;
    const MAX_YEAR = 2035;
    const nowYear = new Date().getFullYear();
    let currentYear = (nowYear >= MIN_YEAR && nowYear <= MAX_YEAR) ? nowYear : MIN_YEAR;
    let targetPercentage = 0.40;
    let vacationLimit = null; // vacation days limit (null = no limit)
    let holidaysCache = [];

    const MONTH_NAMES = [
        "January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"
    ];
    const DAY_NAMES = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    // Polish public holidays, names shown in English
    const HOLIDAY_NAMES = {
        '01-01': "New Year's Day",
        '01-06': 'Epiphany',
        '05-01': 'Labour Day',
        '05-03': 'Constitution Day (3 May)',
        '08-15': 'Assumption of Mary',
        '11-01': "All Saints' Day",
        '11-11': 'Independence Day',
        '12-25': 'Christmas Day',
        '12-26': 'Second Day of Christmas'
    };

    const MODE_OFFICE = 'office';
    const MODE_VACATION = 'vacation';
    const MODE_SICK = 'sick';

    let officeDays = [];
    let vacationDays = [];
    let sickLeaveDays = [];
    let monthModes = new Array(12).fill(MODE_OFFICE);

    let isLoginMode = true;
    let currentUserID = null;
    let currentUserEmail = null;
    let isGoogleSignInInProgress = false;
    let isMicrosoftSignInInProgress = false;
    let saveTimeout = null;
    let isSaving = false;

    // --- DOM ELEMENTS ---
    const authScreen = document.getElementById('auth-screen');
    const resetScreen = document.getElementById('reset-screen');
    const calendarApp = document.getElementById('calendar-app');
    const authTitle = document.getElementById('auth-title');
    const authMainBtn = document.getElementById('auth-main-btn');
    const authToggleBtn = document.getElementById('auth-toggle-btn');
    const authError = document.getElementById('auth-error');
    const googleAuthBtn = document.getElementById('google-auth-btn');
    const googleBtnText = document.getElementById('google-btn-text');
    const microsoftAuthBtn = document.getElementById('microsoft-auth-btn');
    const microsoftBtnText = document.getElementById('microsoft-btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingText = document.getElementById('loading-text');
    const userEmailDisplay = document.getElementById('user-email-display');
    const cloudStatus = document.getElementById('cloud-status');
    const cloudIcon = document.getElementById('cloud-icon');
    const cloudText = document.getElementById('cloud-text');
    const vacationLimitInput = document.getElementById('vacation-limit-input');

    const resetEmailInput = document.getElementById('reset-email');
    const resetError = document.getElementById('reset-error');
    const resetInfo = document.getElementById('reset-info');

    // --- HELPERS ---
    function showLoading(text = 'Loading...') {
        loadingText.textContent = text;
        loadingIndicator.style.display = 'block';
    }

    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }

    function updateCloudStatus(status) {
        cloudStatus.className = status;
        cloudIcon.className = '';
        switch (status) {
            case 'saving':
                cloudIcon.textContent = '‚òÅÔ∏è';
                cloudIcon.className = 'cloud-saving';
                cloudText.textContent = 'Saving...';
                break;
            case 'saved':
                cloudIcon.textContent = '‚úÖ';
                cloudText.textContent = 'Saved';
                break;
            case 'error':
                cloudIcon.textContent = '‚ùå';
                cloudText.textContent = 'Save error';
                break;
            case 'loading':
                cloudIcon.textContent = 'üîÑ';
                cloudText.textContent = 'Loading...';
                break;
        }
    }

    function setGoogleButtonLoading(isLoading) {
        googleAuthBtn.disabled = isLoading;
        googleBtnText.textContent = isLoading ? 'Signing in...' : 'Sign in with Google';
        googleAuthBtn.classList.toggle('opacity-70', isLoading);
    }

    function setMicrosoftButtonLoading(isLoading) {
        if (!microsoftAuthBtn) return;
        microsoftAuthBtn.disabled = isLoading;
        microsoftBtnText.textContent = isLoading ? 'Signing in...' : 'Sign in with Microsoft';
        microsoftAuthBtn.classList.toggle('opacity-70', isLoading);
    }

    // --- AUTH ---

    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        authTitle.innerText = isLoginMode ? "Sign in" : "Register";
        authMainBtn.innerText = isLoginMode ? "Sign in" : "Register";
        authToggleBtn.innerText = isLoginMode ? "Don't have an account? Register!" : "Already have an account? Sign in!";
        authError.classList.add('hidden');
    }

    async function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        authError.classList.add('hidden');
        authMainBtn.disabled = true;

        if (!email || !password) {
            showAuthError("Please fill in both fields.");
            authMainBtn.disabled = false;
            return;
        }

        showLoading(isLoginMode ? 'Signing in...' : 'Registering...');

        try {
            if (isLoginMode) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            console.error("Auth error:", error.code);
            let message = "An error occurred. Please try again.";

            switch (error.code) {
                case 'auth/wrong-password':
                case 'auth/user-not-found':
                case 'auth/invalid-credential':
                    message = "Invalid email or password.";
                    break;
                case 'auth/email-already-in-use':
                    message = "This email is already in use.";
                    break;
                case 'auth/weak-password':
                    message = "Password must be at least 6 characters.";
                    break;
                case 'auth/invalid-email':
                    message = "Invalid email format.";
                    break;
                case 'auth/too-many-requests':
                    message = "Too many attempts. Please wait a moment.";
                    break;
                case 'auth/network-request-failed':
                    message = "Network error.";
                    break;
            }

            showAuthError(message);
        } finally {
            authMainBtn.disabled = false;
            hideLoading();
        }
    }

    function openResetScreen() {
        // Prefill reset email with what's typed in auth screen
        const authEmail = document.getElementById('auth-email').value.trim();
        resetEmailInput.value = authEmail;

        // Hide any previous messages
        authError.classList.add('hidden');
        resetError.classList.add('hidden');
        resetInfo.classList.add('hidden');

        authScreen.style.display = 'none';
        resetScreen.style.display = 'block';
    }

    function backToSignIn() {
        resetError.classList.add('hidden');
        resetInfo.classList.add('hidden');
        resetEmailInput.value = '';

        resetScreen.style.display = 'none';
        authScreen.style.display = 'block';
    }

    async function submitPasswordReset() {
        resetError.classList.add('hidden');
        resetInfo.classList.add('hidden');

        const email = resetEmailInput.value.trim();
        if (!email) {
            resetError.textContent = "Please enter your email address.";
            resetError.classList.remove('hidden');
            return;
        }

        showLoading('Sending password reset email...');

        try {
            await sendPasswordResetEmail(auth, email);
            resetInfo.textContent = "If an account exists for this email, a password reset link has been sent.";
            resetInfo.classList.remove('hidden');
        } catch (error) {
            console.error("Password reset error:", error.code);
            let message = "Could not send password reset email. Please try again.";

            switch (error.code) {
                case 'auth/invalid-email':
                    message = "Invalid email address.";
                    break;
                case 'auth/user-not-found':
                    // You can choose a more generic message to avoid user enumeration.
                    message = "No user found with this email address.";
                    break;
                case 'auth/network-request-failed':
                    message = "Network error.";
                    break;
            }

            resetError.textContent = message;
            resetError.classList.remove('hidden');
        } finally {
            hideLoading();
        }
    }

    async function signInWithGoogle() {
        if (isGoogleSignInInProgress) return;
        isGoogleSignInInProgress = true;
        authError.classList.add('hidden');
        setGoogleButtonLoading(true);

        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            console.error("Google Auth error:", error.code);
            let message = "Error signing in with Google.";
            let shouldTryRedirect = false;

            switch (error.code) {
                case 'auth/popup-closed-by-user':
                    message = "Popup closed. Please try again.";
                    break;
                case 'auth/popup-blocked':
                    shouldTryRedirect = true;
                    break;
                case 'auth/operation-not-allowed':
                    message = "Google sign-in is not enabled.";
                    break;
                case 'auth/network-request-failed':
                    message = "Network error.";
                    break;
            }

            if (shouldTryRedirect) {
                try {
                    showLoading('Redirecting...');
                    await signInWithRedirect(auth, googleProvider);
                    return;
                } catch (e) {
                    message = "Please allow popups and try again.";
                }
            }

            showAuthError(message);
        } finally {
            isGoogleSignInInProgress = false;
            setGoogleButtonLoading(false);
            hideLoading();
        }
    }

    async function signInWithMicrosoft() {
        if (isMicrosoftSignInInProgress) return;
        isMicrosoftSignInInProgress = true;
        authError.classList.add('hidden');
        setMicrosoftButtonLoading(true);

        try {
            await signInWithPopup(auth, microsoftProvider);
        } catch (error) {
            console.error("Microsoft Auth error:", error.code);
            let message = "Error signing in with Microsoft.";
            let shouldTryRedirect = false;

            switch (error.code) {
                case 'auth/popup-closed-by-user':
                    message = "Popup closed. Please try again.";
                    break;
                case 'auth/popup-blocked':
                    shouldTryRedirect = true;
                    break;
                case 'auth/operation-not-allowed':
                    message = "Microsoft sign-in is not enabled in Firebase.";
                    break;
                case 'auth/network-request-failed':
                    message = "Network error.";
                    break;
                case 'auth/account-exists-with-different-credential':
                    message = "An account with this email already exists with a different sign-in method.";
                    break;
            }

            if (shouldTryRedirect) {
                try {
                    showLoading('Redirecting...');
                    await signInWithRedirect(auth, microsoftProvider);
                    return;
                } catch (e) {
                    message = "Please allow popups and try again.";
                }
            }

            showAuthError(message);
        } finally {
            isMicrosoftSignInInProgress = false;
            setMicrosoftButtonLoading(false);
            hideLoading();
        }
    }

    async function handleRedirectResult() {
        try {
            const result = await getRedirectResult(auth);
            if (result) {
                console.log("‚úÖ Signed in via redirect");
            }
        } catch (error) {
            console.error("Redirect error:", error);
            showAuthError("Sign-in error. Please try again.");
        }
    }

    function showAuthError(message) {
        authError.innerHTML = message;
        authError.classList.remove('hidden');
    }

    async function setCurrentUser(user) {
        currentUserID = user.uid;
        currentUserEmail = user.email;
        authScreen.style.display = 'none';
        resetScreen.style.display = 'none';
        calendarApp.style.display = 'block';
        userEmailDisplay.textContent = currentUserEmail;
        await initCalendarApp();
    }

    function signOutUser() {
        if (confirm('Are you sure you want to sign out?\nYour data is safely stored in the cloud.')) {
            signOut(auth).catch((error) => {
                console.error("Sign-out error:", error);
            });
        }
    }

    function unsetCurrentUser() {
        currentUserID = null;
        currentUserEmail = null;
        authScreen.style.display = 'block';
        resetScreen.style.display = 'none';
        calendarApp.style.display = 'none';
        officeDays = [];
        vacationDays = [];
        sickLeaveDays = [];
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
        authError.classList.add('hidden');
        resetError.classList.add('hidden');
        resetInfo.classList.add('hidden');
        resetEmailInput.value = '';
    }

    // --- FIRESTORE ---

    function getDocRef() {
        return doc(db, "users", currentUserID);
    }

    async function loadState() {
        updateCloudStatus('loading');
        showLoading('Loading your calendar...');

        try {
            const docRef = getDocRef();
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const userData = docSnap.data();
                if (userData.calendarData && userData.calendarData[currentYear]) {
                    const yearData = userData.calendarData[currentYear];
                    targetPercentage = parseFloat(yearData.targetPercentage) || 0.40;
                    officeDays = yearData.officeDays || [];
                    vacationDays = yearData.vacationDays || [];
                    sickLeaveDays = yearData.sickLeaveDays || [];
                    vacationLimit = (typeof yearData.vacationLimit === 'number') ? yearData.vacationLimit : null;
                    console.log(`‚úÖ Loaded data for year ${currentYear}`);
                } else {
                    console.log(`‚ÑπÔ∏è No data for year ${currentYear}`);
                    resetToDefaults();
                }
            } else {
                console.log("‚ÑπÔ∏è New user");
                resetToDefaults();
                await saveState();
            }

            updateCloudStatus('saved');
        } catch (e) {
            console.error("Load error:", e);
            updateCloudStatus('error');
            resetToDefaults();
        } finally {
            holidaysCache = calculateHolidays(currentYear);
            monthModes = new Array(12).fill(MODE_OFFICE);
            hideLoading();
        }
    }

    function resetToDefaults() {
        targetPercentage = 0.40;
        officeDays = [];
        vacationDays = [];
        sickLeaveDays = [];
        vacationLimit = null;
    }

    async function saveState() {
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }

        updateCloudStatus('saving');

        saveTimeout = setTimeout(async () => {
            if (isSaving) return;
            isSaving = true;

            const dataToSave = {
                targetPercentage: targetPercentage,
                officeDays: [...officeDays],
                vacationDays: [...vacationDays],
                sickLeaveDays: [...sickLeaveDays],
                vacationLimit: vacationLimit,
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(
                    getDocRef(),
                    {
                        email: currentUserEmail,
                        lastLogin: new Date().toISOString(),
                        calendarData: {
                            [currentYear]: dataToSave
                        }
                    },
                    { merge: true }
                );

                console.log(`‚úÖ Saved to Firebase for year ${currentYear}`);
                updateCloudStatus('saved');
            } catch (e) {
                console.error("Save error:", e);
                updateCloudStatus('error');
            } finally {
                isSaving = false;
            }
        }, 800);
    }

    // --- CALENDAR LOGIC ---

    function getEasterDate(year) {
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const p = (h + l - 7 * m + 114);
        const month = Math.floor(p / 31) - 1;
        const day = (p % 31) + 1;
        return new Date(year, month, day);
    }

    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function calculateHolidays(year) {
        const h = [
            `${year}-01-01`,
            `${year}-01-06`,
            `${year}-05-01`,
            `${year}-05-03`,
            `${year}-08-15`,
            `${year}-11-01`,
            `${year}-11-11`,
            `${year}-12-25`,
            `${year}-12-26`
        ];

        const easter = getEasterDate(year);
        h.push(formatDate(easter));              // Easter Sunday
        h.push(formatDate(addDays(easter, 1)));  // Easter Monday
        h.push(formatDate(addDays(easter, 49))); // Pentecost
        h.push(formatDate(addDays(easter, 60))); // Corpus Christi

        return h;
    }

    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function isWeekend(date) {
        const day = date.getDay();
        return day === 0 || day === 6;
    }

    function initYearSelector() {
        const selector = document.getElementById('year-selector');
        selector.innerHTML = '';

        for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.text = y;
            if (y === currentYear) option.selected = true;
            selector.appendChild(option);
        }

        document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
    }

    async function changeYear(val) {
        currentYear = parseInt(val);
        document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
        await loadState();
        initTargetSelector();
        initVacationLimitInput();
        updateYearlyStats();
        renderCalendar();
    }

    function initTargetSelector() {
        const selector = document.getElementById('target-selector');
        selector.innerHTML = '';

        for (let i = 0; i <= 100; i += 5) {
            const option = document.createElement('option');
            option.value = (i / 100).toFixed(2);
            option.text = i + '%';
            if (Math.abs(parseFloat(option.value) - targetPercentage) < 0.01) {
                option.selected = true;
            }
            selector.appendChild(option);
        }
    }

    function initVacationLimitInput() {
        if (!vacationLimitInput) return;
        if (vacationLimit === null || typeof vacationLimit !== 'number' || isNaN(vacationLimit)) {
            vacationLimitInput.value = '';
        } else {
            vacationLimitInput.value = vacationLimit;
        }
    }

    function changeTarget(val) {
        targetPercentage = parseFloat(val);
        saveState();
        updateYearlyStats();
        renderCalendar();
    }

    function changeVacationLimit(val) {
        if (val === '' || val === null) {
            vacationLimit = null;
        } else {
            let n = parseInt(val, 10);
            if (isNaN(n) || n < 0) n = 0;
            vacationLimit = n;
        }
        saveState();
    }

    function setMode(monthIndex, mode) {
        monthModes[monthIndex] = mode;
        renderCalendar();
    }

    function toggleDay(dateStr, monthIndex) {
        const currentMode = monthModes[monthIndex];
        const date = new Date(dateStr);

        // Do not change weekends or "real" public holidays (except Christmas Eve)
        if (isWeekend(date) || (holidaysCache.includes(dateStr) && dateStr !== `${currentYear}-12-24`)) return;

        const removeFromAll = () => {
            officeDays = officeDays.filter(d => d !== dateStr);
            vacationDays = vacationDays.filter(d => d !== dateStr);
            sickLeaveDays = sickLeaveDays.filter(d => d !== dateStr);
        };

        if (currentMode === MODE_OFFICE) {
            if (officeDays.includes(dateStr)) {
                officeDays = officeDays.filter(d => d !== dateStr);
            } else {
                removeFromAll();
                officeDays.push(dateStr);
            }
        } else if (currentMode === MODE_VACATION) {
            if (vacationDays.includes(dateStr)) {
                vacationDays = vacationDays.filter(d => d !== dateStr);
            } else {
                // Check vacation limit
                if (vacationLimit !== null && vacationLimit >= 0 && vacationDays.length >= vacationLimit) {
                    alert('You have reached the configured vacation days limit.');
                    return;
                }
                removeFromAll();
                vacationDays.push(dateStr);
            }
        } else if (currentMode === MODE_SICK) {
            if (sickLeaveDays.includes(dateStr)) {
                sickLeaveDays = sickLeaveDays.filter(d => d !== dateStr);
            } else {
                removeFromAll();
                sickLeaveDays.push(dateStr);
            }
        }

        saveState();
        updateYearlyStats();
        renderCalendar();
    }

    function clearAll() {
        if (confirm(`Clear all selections for year ${currentYear}?\n\nThis will remove all office days, vacations and sick leaves.`)) {
            officeDays = [];
            vacationDays = [];
            sickLeaveDays = [];
            saveState();
            updateYearlyStats();
            renderCalendar();
        }
    }

    function getMonthData(monthIndex) {
        const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
        let startDay = new Date(currentYear, monthIndex, 1).getDay();
        let firstDayOffset = startDay === 0 ? 6 : startDay - 1;

        let days = [];
        let baseWorkingDaysCount = 0;
        let saturdayHolidayCount = 0;
        let saturdayHolidayNames = [];
        let vacationCount = 0;
        let sickLeaveCount = 0;
        let weekdayHolidayCount = 0;

        for (let i = 1; i <= daysInMonth; i++) {
            const currentDate = new Date(currentYear, monthIndex, i);
            const dateStr = formatDate(currentDate);
            const _isWeekend = isWeekend(currentDate);
            const dayOfWeek = currentDate.getDay();

            const isWigilia = (dateStr === `${currentYear}-12-24`); // Christmas Eve treated specially
            const isRealHoliday = holidaysCache.includes(dateStr) && !isWigilia;
            const isVisualHoliday = holidaysCache.includes(dateStr) || isWigilia;

            const _isOffice = officeDays.includes(dateStr);
            const _isVacation = vacationDays.includes(dateStr);
            const _isSickLeave = sickLeaveDays.includes(dateStr);

            if (!_isWeekend) baseWorkingDaysCount++;
            if (!_isWeekend && isRealHoliday) weekdayHolidayCount++;

            // Public holidays on Saturday (for info, not for working days calc)
            if (isRealHoliday && dayOfWeek === 6) {
                saturdayHolidayCount++;
                const monthDay = dateStr.slice(5);
                const name = HOLIDAY_NAMES[monthDay] || 'Holiday';
                saturdayHolidayNames.push(name);
            }

            if (!_isWeekend && !isRealHoliday && _isVacation) vacationCount++;
            if (!_isWeekend && !isRealHoliday && _isSickLeave) sickLeaveCount++;

            days.push({
                day: i,
                dateStr,
                isWeekend: _isWeekend,
                isHoliday: isVisualHoliday,
                isWigilia,
                isOffice: _isOffice,
                isVacation: _isVacation,
                isSickLeave: _isSickLeave
            });
        }

        // Do not subtract saturdayHolidayCount ‚Äì holiday on Saturday does not reduce working days
        let daysToWorkBase = baseWorkingDaysCount - weekdayHolidayCount;
        if (daysToWorkBase < 0) daysToWorkBase = 0;

        let effectiveWorkingDays = daysToWorkBase - vacationCount - sickLeaveCount;
        if (effectiveWorkingDays < 0) effectiveWorkingDays = 0;

        const requiredDays = Math.ceil(effectiveWorkingDays * targetPercentage);

        return {
            name: MONTH_NAMES[monthIndex],
            days,
            firstDayOffset,
            effectiveWorkingDays,
            vacationCount,
            sickLeaveCount,
            requiredDays,
            saturdayHolidayCount,
            saturdayHolidayNames
        };
    }

    function updateYearlyStats() {
        document.getElementById('summary-target-label').innerText = Math.round(targetPercentage * 100) + '%';

        let totalEffectiveWorking = 0;
        let totalRequired = 0;
        let totalVacation = 0;
        let totalSick = 0;

        for (let m = 0; m < 12; m++) {
            const data = getMonthData(m);
            totalEffectiveWorking += data.effectiveWorkingDays;
            totalRequired += data.requiredDays;
            totalVacation += data.vacationCount;
            totalSick += data.sickLeaveCount;
        }

        document.getElementById('year-working-days').innerText = totalEffectiveWorking;
        document.getElementById('year-required-days').innerText = totalRequired;
        document.getElementById('year-absence-days').innerText = totalVacation + totalSick;
        document.getElementById('vacation-count').innerText = totalVacation;
        document.getElementById('sick-count').innerText = totalSick;

        const selectedEl = document.getElementById('year-selected-days');
        selectedEl.innerText = officeDays.length;

        if (officeDays.length >= totalRequired) {
            selectedEl.classList.remove('text-slate-700');
            selectedEl.classList.add('text-green-600');
        } else {
            selectedEl.classList.remove('text-green-600');
            selectedEl.classList.add('text-slate-700');
        }
    }

    function renderCalendar() {
        const container = document.getElementById('calendar-grid');
        container.innerHTML = '';

        for (let m = 0; m < 12; m++) {
            const data = getMonthData(m);
            const currentOfficeCount = data.days.filter(d => d.isOffice).length;
            const isMet = currentOfficeCount >= data.requiredDays;
            const progressPercent = data.requiredDays > 0 ? Math.min(100, (currentOfficeCount / data.requiredDays) * 100) : 100;
            const progressColor = isMet ? 'bg-green-500' : 'bg-blue-500';
            const currentMode = monthModes[m];

            const monthCard = document.createElement('div');
            monthCard.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col";

            const btnBase = "py-1.5 px-2 rounded text-xs font-semibold transition-all border flex items-center justify-center gap-1 cursor-pointer select-none flex-1";
            const officeBtnClass = currentMode === MODE_OFFICE
                ? "bg-green-600 text-white border-green-700 shadow-sm"
                : "bg-white text-slate-500 border-slate-200 hover:bg-green-50 hover:text-green-600";
            const vacationBtnClass = currentMode === MODE_VACATION
                ? "bg-amber-500 text-white border-amber-600 shadow-sm"
                : "bg-white text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-600";
            const sickBtnClass = currentMode === MODE_SICK
                ? "bg-rose-500 text-white border-rose-600 shadow-sm"
                : "bg-white text-slate-500 border-slate-200 hover:bg-rose-50 hover:text-rose-600";

            let statusClass = isMet ? "text-green-600 bg-green-50" : "text-slate-500 bg-slate-50";
            let statusIcon = isMet
                ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`
                : '';

            // Note about holidays on Saturday ‚Äì extra day off info
            let noteHtml = '';
            if (data.saturdayHolidayCount > 0) {
                const holidayNames = data.saturdayHolidayNames.join(', ');
                noteHtml = `
                    <div class="mx-4 mt-2 px-3 py-2 bg-purple-50 border border-purple-100 rounded-md text-xs text-purple-800">
                        üéÅ <strong>${data.saturdayHolidayCount} extra day off</strong> available (${holidayNames} falls on Saturday)
                    </div>
                `;
            }

            let absenceSummary = '';
            if (data.vacationCount > 0 || data.sickLeaveCount > 0) {
                const parts = [];
                if (data.vacationCount > 0) parts.push(`${data.vacationCount} V`);
                if (data.sickLeaveCount > 0) parts.push(`${data.sickLeaveCount} SL`);
                absenceSummary = `<span class="text-amber-600">(${parts.join('/')})</span>`;
            }

            let html = `
                <div class="p-4 border-b border-slate-100 ${statusClass}">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-bold text-lg">${data.name}</h2>
                        <div class="flex items-center gap-1">
                            ${statusIcon}
                            <span class="text-sm font-semibold">${currentOfficeCount}/${data.requiredDays}</span>
                        </div>
                    </div>
                    <div class="flex gap-2 mode-buttons">
                        <button onclick="setMode(${m}, '${MODE_OFFICE}')" class="${btnBase} ${officeBtnClass}">üè¢ Office</button>
                        <button onclick="setMode(${m}, '${MODE_VACATION}')" class="${btnBase} ${vacationBtnClass}">üèñÔ∏è Vacation</button>
                        <button onclick="setMode(${m}, '${MODE_SICK}')" class="${btnBase} ${sickBtnClass}">üè• Sick leave</button>
                    </div>
                </div>
                <div class="w-full h-1.5 bg-slate-100">
                    <div class="h-1.5 ${progressColor} transition-all duration-500" style="width: ${progressPercent}%"></div>
                </div>
                ${noteHtml}
                <div class="p-4 flex-grow pt-2">
                    <div class="flex justify-between text-xs text-slate-400 mb-2 px-1">
                        <span>Working: ${data.effectiveWorkingDays} ${absenceSummary}</span>
                        <span>Target: ${data.requiredDays}</span>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        ${DAY_NAMES.map(n => `<div class="text-xs font-bold text-slate-400">${n}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-sm">
           `;

            for (let i = 0; i < data.firstDayOffset; i++) {
                html += `<div class="aspect-square"></div>`;
            }

            data.days.forEach(day => {
                let classes = "aspect-square flex items-center justify-center rounded-lg select-none text-sm font-medium day-cell relative ";
                let onclick = "";
                let title = "";

                if (day.isHoliday) {
                    classes += "bg-red-50 text-red-400 border border-red-100 disabled cursor-not-allowed";
                    const monthDay = day.dateStr.slice(5);
                    title = day.isWigilia ? 'Christmas Eve' : (HOLIDAY_NAMES[monthDay] || 'Holiday');
                    html += `<div class="${classes}" title="${title}">${day.day}<span class="absolute top-0 right-0 w-2 h-2 bg-red-400 rounded-full -mr-0.5 -mt-0.5 opacity-50"></span></div>`;
                } else if (day.isWeekend) {
                    classes += "bg-slate-100 text-slate-400 disabled cursor-default";
                    html += `<div class="${classes}">${day.day}</div>`;
                } else {
                    onclick = `onclick="toggleDay('${day.dateStr}', ${m})"`;

                    if (day.isOffice) {
                        classes += "bg-green-500 text-white shadow-md shadow-green-200 border border-green-600";
                        title = "Office day";
                    } else if (day.isVacation) {
                        classes += "bg-amber-400 text-white shadow-md shadow-amber-200 border border-amber-500";
                        title = "Vacation";
                    } else if (day.isSickLeave) {
                        classes += "bg-rose-400 text-white shadow-md shadow-rose-200 border border-rose-500";
                        title = "Sick leave";
                    } else {
                        classes += "bg-white text-slate-700 border border-slate-200 ";
                        if (currentMode === MODE_VACATION) {
                            classes += "hover:bg-amber-50 hover:border-amber-300";
                        } else if (currentMode === MODE_SICK) {
                            classes += "hover:bg-rose-50 hover:border-rose-300";
                        } else {
                            classes += "hover:bg-green-50 hover:border-green-300";
                        }
                        title = "Remote work (click to change)";
                    }

                    html += `<div class="${classes}" ${onclick} title="${title}">${day.day}</div>`;
                }
            });

            html += `</div></div>`;
            monthCard.innerHTML = html;
            container.appendChild(monthCard);
        }
    }

    async function initCalendarApp() {
        initYearSelector();
        await loadState();
        initTargetSelector();
        initVacationLimitInput();
        updateYearlyStats();
        renderCalendar();
    }

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        showLoading('Initializing...');
        await handleRedirectResult();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("üë§ Signed in as:", user.email);
                await setCurrentUser(user);
            } else {
                console.log("üë§ Signed out");
                unsetCurrentUser();
            }
            hideLoading();
        });
    });

    // --- GLOBAL EXPORTS ---
    window.handleAuth = handleAuth;
    window.toggleAuthMode = toggleAuthMode;
    window.openResetScreen = openResetScreen;
    window.backToSignIn = backToSignIn;
    window.submitPasswordReset = submitPasswordReset;
    window.signInWithGoogle = signInWithGoogle;
    window.signInWithMicrosoft = signInWithMicrosoft;
    window.signOutUser = signOutUser;
    window.changeYear = changeYear;
    window.changeTarget = changeTarget;
    window.changeVacationLimit = changeVacationLimit;
    window.clearAll = clearAll;
    window.setMode = setMode;
    window.toggleDay = toggleDay;
</script>
</body>
</html>
