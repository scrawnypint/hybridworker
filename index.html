<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kalkulator i planer pracy hybrydowej (2025-2035).">
    <meta name="author" content="Hybrid Work Planner">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
    
    <title>Planer Pracy Hybrydowej</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .day-cell { transition: all 0.15s ease-out; }
        .day-cell:hover:not(.disabled) { transform: scale(1.15); z-index: 10; cursor: pointer; }

        .year-select {
            background: transparent;
            border: none;
            color: inherit;
            font-weight: inherit;
            font-size: inherit;
            cursor: pointer;
            border-bottom: 2px solid #bfdbfe;
            padding: 0 0.2em;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
        }
        .year-select:hover { border-bottom-color: #60a5fa; }
        .year-select:focus { background-color: #eff6ff; border-radius: 4px; }

        @media print {
            body { background: white; padding: 0; }
            .max-w-7xl { max-width: 100%; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
            button, select, .mode-buttons { display: none !important; }
            h1::after { content: " " attr(data-year); }
            #calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
            .day-cell { border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 mb-2 flex justify-center items-center gap-2 flex-wrap" id="main-title">
                Kalendarz Pracy Hybrydowej 
                <div class="relative inline-block">
                    <select id="year-selector" onchange="changeYear(this.value)" class="year-select text-blue-600">
                        </select>
                </div>
            </h1>
            <p class="text-slate-600 mb-4 flex justify-center items-center gap-2">
                Planer obecno≈õci. Cel: 
                <span class="relative inline-block">
                    <select id="target-selector" onchange="changeTarget(this.value)" class="appearance-none font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-200 hover:border-blue-400 cursor-pointer focus:outline-none focus:bg-blue-100 rounded px-2 py-0.5 text-center transition-all pr-6">
                        </select>
                    <span class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400 text-xs">‚ñº</span>
                </span>
                efektywnych dni pracy.
            </p>
            
            <div class="flex flex-wrap justify-center gap-4 text-sm bg-white p-3 rounded-xl shadow-sm inline-flex">
                <div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Dzie≈Ñ w biurze</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-amber-300 rounded mr-2"></div>Urlop / L4</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>Praca zdalna</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-slate-100 border border-slate-200 rounded mr-2"></div>Weekend</div>
                <div class="flex items-center"><div class="w-4 h-4 bg-red-100 border border-red-200 text-red-800 rounded mr-2 flex justify-center items-center text-xs font-bold">!</div>≈öwiƒôto</div>
            </div>
            
            <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                <div>
                    <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Do przepracowania <span class="current-year-display"></span></div>
                    <div class="text-xl font-bold text-slate-700" id="year-working-days">0</div>
                    <div class="text-xs text-slate-400 font-normal">(po odjƒôciu urlop√≥w)</div>
                </div>
                <div>
                    <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Cel biurowy (<span id="summary-target-label">40%</span>)</div>
                    <div class="text-xl font-bold text-blue-600" id="year-required-days">0</div>
                </div>
                <div>
                    <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Zaplanowane w biurze</div>
                    <div class="text-xl font-bold text-green-600" id="year-selected-days">0</div>
                </div>
            </div>

            <div class="mt-4 text-sm text-slate-400 text-center">
                <button onclick="clearAll()" class="text-red-400 hover:text-red-600 underline text-xs">Zresetuj kalendarz dla roku <span class="current-year-display"></span></button>
            </div>
        </header>

        <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>

        <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
            Dane zapisujƒÖ siƒô w pamiƒôci przeglƒÖdarki. Uwzglƒôdniono polskie ≈õwiƒôta. <br>
            <strong>Zasada oblicze≈Ñ:</strong> (Dni robocze - Urlopy) * % Celu = Wymagane dni (zaokrƒÖglane w g√≥rƒô).<br>
            Korekta: -1 dzie≈Ñ pracy za ≈õwiƒôto przypadajƒÖce w sobotƒô (dla 2026 r. sƒÖ to 2 dni: 15.08, 26.12).
        </footer>
    </div>

    <script>
        // --- Configuration & Helpers ---
        
        const MIN_YEAR = 2025;
        const MAX_YEAR = 2035;
        const nowYear = new Date().getFullYear();
        let currentYear = (nowYear >= MIN_YEAR && nowYear <= MAX_YEAR) ? nowYear : MIN_YEAR;

        let targetPercentage = 0.40;
        let holidaysCache = [];

        const MONTH_NAMES = [
            "Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
            "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"
        ];
        const DAY_NAMES = ["Pn", "Wt", "≈ör", "Cz", "Pt", "Sb", "Nd"];

        let officeDays = [];
        let vacationDays = [];
        let vacationModes = new Array(12).fill(false);

        // --- Easter & Holiday Logic ---
        function getEasterDate(year) {
            const a = year % 19;
            const b = Math.floor(year / 100);
            const c = year % 100;
            const d = Math.floor(b / 4);
            const e = b % 4;
            const f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3);
            const h = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4);
            const k = c % 4;
            const l = (32 + 2 * e + 2 * i - h - k) % 7;
            const m = Math.floor((a + 11 * h + 22 * l) / 451);
            const p = (h + l - 7 * m + 114);
            const month = Math.floor(p / 31) - 1; 
            const day = (p % 31) + 1;
            return new Date(year, month, day);
        }

        function addDays(date, days) {
            const result = new Date(date);
            result.setDate(result.getDate() + days);
            return result;
        }

        function calculateHolidays(year) {
            const h = [];
            // Fixed Holidays (9 entries)
            h.push(`${year}-01-01`); // Nowy Rok (1)
            h.push(`${year}-01-06`); // Trzech Kr√≥li (2)
            h.push(`${year}-05-01`); // ≈öwiƒôto Pracy (3)
            h.push(`${year}-05-03`); // Konstytucja 3 Maja (4)
            h.push(`${year}-08-15`); // Wniebowziƒôcie NMP (5)
            h.push(`${year}-11-01`); // Wszystkich ≈öwiƒôtych (6)
            h.push(`${year}-11-11`); // ≈öwiƒôto Niepodleg≈Ço≈õci (7)
            h.push(`${year}-12-25`); // Bo≈ºe Narodzenie 1 (8)
            h.push(`${year}-12-26`); // Bo≈ºe Narodzenie 2 (9)
            
            // Movable Holidays (4 entries)
            const easter = getEasterDate(year);
            const easterMonday = addDays(easter, 1);
            const corpusChristi = addDays(easter, 60); 
            const pentecost = addDays(easter, 49); // Zes≈Çanie Ducha ≈öwiƒôtego (Sunday)

            h.push(formatDate(easter));
            h.push(formatDate(easterMonday));
            h.push(formatDate(corpusChristi));
            h.push(formatDate(pentecost));

            return h;
        }

        function formatDate(date) {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        }

        function loadState() {
            targetPercentage = parseFloat(localStorage.getItem(`targetPercentage_${currentYear}`)) || 0.40;
            officeDays = JSON.parse(localStorage.getItem(`officeDays_${currentYear}`)) || [];
            vacationDays = JSON.parse(localStorage.getItem(`vacationDays_${currentYear}`)) || [];
            holidaysCache = calculateHolidays(currentYear);
            vacationModes = new Array(12).fill(false); 
        }

        function saveState() {
            localStorage.setItem(`officeDays_${currentYear}`, JSON.stringify(officeDays));
            localStorage.setItem(`vacationDays_${currentYear}`, JSON.stringify(vacationDays));
            localStorage.setItem(`targetPercentage_${currentYear}`, targetPercentage);
            updateYearlyStats();
        }

        function initYearSelector() {
            const selector = document.getElementById('year-selector');
            selector.innerHTML = '';
            for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.text = y;
                if (y === currentYear) option.selected = true;
                selector.appendChild(option);
            }
            
            document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
            document.getElementById('main-title').setAttribute('data-year', currentYear);
        }

        function changeYear(val) {
            currentYear = parseInt(val);
            document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
            document.getElementById('main-title').setAttribute('data-year', currentYear);
            
            loadState();
            initTargetSelector(); 
            updateYearlyStats();
            renderCalendar();
        }

        function initTargetSelector() {
            const selector = document.getElementById('target-selector');
            selector.innerHTML = '';
            for (let i = 0; i <= 100; i += 5) {
                const option = document.createElement('option');
                option.value = (i / 100).toFixed(2);
                option.text = i + '%';
                if (Math.abs(parseFloat(option.value) - targetPercentage) < 0.01) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }

        function changeTarget(val) {
            targetPercentage = parseFloat(val);
            saveState();
            updateYearlyStats();
            renderCalendar();
        }

        function setMode(monthIndex, isVacation) {
            vacationModes[monthIndex] = isVacation;
            renderCalendar();
        }

        function toggleDay(dateStr, monthIndex) {
            const isVacationMode = vacationModes[monthIndex];
            const date = new Date(dateStr);
            
            // Block modification of weekends and actual holidays (except Wigilia visual)
            if (isWeekend(date) || (holidaysCache.includes(dateStr) && dateStr !== `${currentYear}-12-24`)) return;

            if (isVacationMode) {
                if (vacationDays.includes(dateStr)) {
                    vacationDays = vacationDays.filter(d => d !== dateStr);
                } else {
                    vacationDays.push(dateStr);
                    officeDays = officeDays.filter(d => d !== dateStr);
                }
            } else {
                if (officeDays.includes(dateStr)) {
                    officeDays = officeDays.filter(d => d !== dateStr);
                } else {
                    officeDays.push(dateStr);
                    vacationDays = vacationDays.filter(d => d !== dateStr);
                }
            }
            saveState();
            renderCalendar();
        }

        function clearAll() {
            if(confirm(`Czy na pewno chcesz wyczy≈õciƒá ca≈Çy kalendarz dla roku ${currentYear}?`)) {
                officeDays = [];
                vacationDays = [];
                saveState();
                renderCalendar();
            }
        }

        function isWeekend(date) {
            const day = date.getDay();
            return day === 0 || day === 6; // 0=Sunday, 6=Saturday
        }

        function getMonthData(monthIndex) {
            const date = new Date(currentYear, monthIndex, 1);
            const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
            
            let startDay = date.getDay(); 
            let firstDayOffset = startDay === 0 ? 6 : startDay - 1;

            let days = [];
            // Statutory working days before any compensation or vacation
            let baseWorkingDaysCount = 0; 
            let saturdayHolidayCount = 0;
            let vacationCount = 0;

            for (let i = 1; i <= daysInMonth; i++) {
                const currentDate = new Date(currentYear, monthIndex, i);
                const dateStr = formatDate(currentDate);
                const _isWeekend = isWeekend(currentDate);
                
                const isWigilia = (dateStr === `${currentYear}-12-24`);
                const isRealHoliday = holidaysCache.includes(dateStr) && !isWigilia;
                const isVisualHoliday = holidaysCache.includes(dateStr) || isWigilia;

                const _isOffice = officeDays.includes(dateStr);
                const _isVacation = vacationDays.includes(dateStr);
                const dayOfWeek = currentDate.getDay(); // 0=Sun, 6=Sat

                // 1. Calculate base Mon-Fri working days (excluding holidays)
                let isWorkingDayCandidate = !_isWeekend && !isRealHoliday;
                if (isWorkingDayCandidate) { 
                    baseWorkingDaysCount++; 
                }

                // 2. Count holidays falling on a Saturday (for compensation)
                if (isRealHoliday && dayOfWeek === 6) {
                    saturdayHolidayCount++;
                }

                // 3. Count planned vacation days that fall on a Mon-Fri working day
                if (isWorkingDayCandidate && _isVacation) {
                    vacationCount++;
                }

                days.push({
                    day: i,
                    dateStr: dateStr,
                    isWeekend: _isWeekend,
                    isHoliday: isVisualHoliday,
                    isWigilia: isWigilia,
                    isOffice: _isOffice,
                    isVacation: _isVacation
                });
            }

            // Apply Saturday holiday compensation (Polish Labour Code)
            baseWorkingDaysCount -= saturdayHolidayCount;
            if (baseWorkingDaysCount < 0) baseWorkingDaysCount = 0;

            // Calculate Effective Working Days (after statutory holidays and planned vacation)
            let effectiveWorkingDays = baseWorkingDaysCount - vacationCount;
            if (effectiveWorkingDays < 0) effectiveWorkingDays = 0;

            // Calculate Required Office Days (Ceiling rounding)
            const requiredDays = Math.ceil(effectiveWorkingDays * targetPercentage);

            return {
                name: MONTH_NAMES[monthIndex],
                days,
                firstDayOffset,
                effectiveWorkingDays,
                vacationCount,
                requiredDays,
                saturdayHolidayCount
            };
        }

        function updateYearlyStats() {
            const labelEl = document.getElementById('summary-target-label');
            if (labelEl) labelEl.innerText = Math.round(targetPercentage * 100) + '%';

            let totalEffectiveWorking = 0;
            let totalRequired = 0;
            
            for(let m=0; m<12; m++) {
                const data = getMonthData(m);
                totalEffectiveWorking += data.effectiveWorkingDays; 
                totalRequired += data.requiredDays;
            }

            const totalSelected = officeDays.length;

            document.getElementById('year-working-days').innerText = totalEffectiveWorking;
            document.getElementById('year-required-days').innerText = totalRequired;
            
            const selectedEl = document.getElementById('year-selected-days');
            selectedEl.innerText = totalSelected;
            
            if (totalSelected >= totalRequired) {
                selectedEl.classList.remove('text-slate-700');
                selectedEl.classList.add('text-green-600');
            } else {
                selectedEl.classList.remove('text-green-600');
                selectedEl.classList.add('text-slate-700');
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-grid');
            container.innerHTML = '';

            for (let m = 0; m < 12; m++) {
                const data = getMonthData(m);
                const currentOfficeCount = data.days.filter(d => d.isOffice).length;
                const isMet = currentOfficeCount >= data.requiredDays;
                
                const progressPercent = data.requiredDays > 0 ? Math.min(100, (currentOfficeCount / data.requiredDays) * 100) : (data.effectiveWorkingDays === 0 ? 100 : 0);
                const progressColor = isMet ? 'bg-green-500' : 'bg-blue-500';

                const monthCard = document.createElement('div');
                monthCard.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col";

                const isVacationMode = vacationModes[m];
                
                const btnBase = "flex-1 py-1.5 px-2 rounded text-xs font-semibold transition-colors border flex items-center justify-center gap-1 cursor-pointer select-none";
                const officeBtnClass = !isVacationMode
                    ? "bg-blue-600 text-white border-blue-700 shadow-sm ring-1 ring-blue-200"
                    : "bg-white text-slate-500 border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200";
                const vacationBtnClass = isVacationMode
                    ? "bg-amber-400 text-amber-950 border-amber-500 shadow-sm ring-1 ring-amber-200"
                    : "bg-white text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-700 hover:border-amber-300";

                let statusClass = isMet ? "text-green-600 bg-green-50" : "text-slate-500 bg-slate-50";
                let statusIcon = isMet ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : '';

                let noteHtml = '';
                if (data.saturdayHolidayCount > 0) {
                    noteHtml = `
                        <div class="mx-4 mt-2 px-3 py-2 bg-orange-50 border border-orange-100 rounded-md text-xs text-orange-800 flex items-start">
                            <span class="mr-2">‚ÑπÔ∏è</span>
                            <span>odliczono ${data.saturdayHolidayCount} dzie≈Ñ za ≈õwiƒôto w sobotƒô</span>
                        </div>
                    `;
                }

                let html = `
                    <div class="p-4 border-b border-slate-100 flex justify-between items-center ${statusClass}">
                        <h2 class="font-bold text-lg">${data.name}</h2>
                        <div class="flex items-center gap-1">
                            ${statusIcon}
                            <span class="text-sm font-semibold">${currentOfficeCount}/${data.requiredDays}</span>
                        </div>
                    </div>
                    
                    <div class="w-full h-1.5 bg-slate-100">
                        <div class="h-1.5 ${progressColor} transition-all duration-500" style="width: ${progressPercent}%"></div>
                    </div>
                    
                    <div class="px-4 mt-3 flex gap-2 mode-buttons">
                        <button onclick="setMode(${m}, false)" class="${btnBase} ${officeBtnClass}">
                            üè¢ Biuro
                        </button>
                        <button onclick="setMode(${m}, true)" class="${btnBase} ${vacationBtnClass}">
                            üèñÔ∏è Urlop / L4
                        </button>
                    </div>

                    ${noteHtml}

                    <div class="p-4 flex-grow pt-2">
                        <div class="flex justify-between text-xs text-slate-400 mb-2 px-1">
                            <span title="Dni robocze minus ustawowe ≈õwiƒôta i urlopy (${data.vacationCount} dni)">Do pracy: ${data.effectiveWorkingDays}</span>
                            <span>Cel: ${data.requiredDays}</span>
                        </div>

                        <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                            ${DAY_NAMES.map(n => `<div class="text-xs font-bold text-slate-400">${n}</div>`).join('')}
                        </div>
                        <div class="grid grid-cols-7 gap-1 text-sm">
                `;

                for (let i = 0; i < data.firstDayOffset; i++) {
                    html += `<div class="aspect-square"></div>`;
                }

                data.days.forEach(day => {
                    let classes = "aspect-square flex items-center justify-center rounded-lg select-none text-sm font-medium day-cell relative ";
                    let onclick = "";

                    if (day.isHoliday) {
                        classes += "bg-red-50 text-red-400 border border-red-100 disabled cursor-not-allowed";
                        html += `
                            <div class="${classes}" title="${day.isWigilia ? 'Wigilia' : '≈öwiƒôto'}">
                                ${day.day}
                                <span class="absolute top-0 right-0 w-2 h-2 bg-red-400 rounded-full -mr-0.5 -mt-0.5 opacity-50"></span>
                            </div>`;
                    } else if (day.isWeekend) {
                        classes += "bg-slate-100 text-slate-400 disabled cursor-default";
                        html += `<div class="${classes}">${day.day}</div>`;
                    } else {
                        // Actionable Day
                        onclick = `onclick="toggleDay('${day.dateStr}', ${m})"`;
                        
                        if (day.isOffice) {
                            classes += "bg-green-500 text-white shadow-md shadow-green-200 border border-green-600";
                        } else if (day.isVacation) {
                            classes += "bg-amber-300 text-amber-900 border border-amber-400";
                        } else {
                            classes += "bg-white text-slate-700 border border-slate-200 ";
                            if (isVacationMode) {
                                classes += "hover:bg-amber-50 hover:border-amber-300 hover:text-amber-700";
                            } else {
                                classes += "hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700";
                            }
                        }
                        html += `<div class="${classes}" ${onclick}>${day.day}</div>`;
                    }
                });

                html += `
                        </div>
                    </div>
                `;

                monthCard.innerHTML = html;
                container.appendChild(monthCard);
            }
        }

        // Initialize
        initYearSelector();
        loadState();
        initTargetSelector();
        updateYearlyStats();
        renderCalendar();

    </script>
</body>
</html>
