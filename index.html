<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planer Pracy Hybrydowej (Firebase)</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .day-cell { transition: all 0.15s ease-out; }
        .day-cell:hover:not(.disabled) { transform: scale(1.15); z-index: 10; cursor: pointer; }
        .year-select { background: transparent; border: none; font-size: inherit; font-weight: inherit; cursor: pointer; border-bottom: 2px solid #bfdbfe; outline: none; }
        .auth-form input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; width: 100%; margin-bottom: 10px; }
        /* Ukrywanie elementów przy druku */
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <div id="auth-bar" class="flex justify-end mb-4 text-sm no-print">
            </div>

        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 mb-2 flex justify-center items-center gap-2 flex-wrap">
                Kalendarz Pracy Hybrydowej 
                <select id="year-selector" class="year-select text-blue-600"></select>
            </h1>
            
            <div id="app-interface" class="hidden">
                <p class="text-slate-600 mb-4">
                    Cel: <select id="target-selector" class="font-bold text-blue-600 bg-transparent border-b border-blue-300"></select>
                </p>

                <div class="flex flex-wrap justify-center gap-4 text-sm bg-white p-3 rounded-xl shadow-sm inline-flex mb-6">
                    <div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Biuro</div>
                    <div class="flex items-center"><div class="w-4 h-4 bg-amber-300 rounded mr-2"></div>Urlop</div>
                    <div class="flex items-center"><div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>Zdalna</div>
                </div>

                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-1 sm:grid-cols-3 gap-4 text-center mb-6">
                    <div><div class="text-xs text-slate-500 uppercase">Pracujące</div><div id="stat-working" class="text-xl font-bold text-slate-700">0</div></div>
                    <div><div class="text-xs text-slate-500 uppercase">Wymagane</div><div id="stat-required" class="text-xl font-bold text-blue-600">0</div></div>
                    <div><div class="text-xs text-slate-500 uppercase">Zaplanowane</div><div id="stat-selected" class="text-xl font-bold text-green-600">0</div></div>
                </div>
            </div>
        </header>

        <div id="auth-container" class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-md border border-slate-200 hidden no-print">
            <h2 id="auth-title" class="text-2xl font-bold text-center mb-6 text-blue-900">Zaloguj się</h2>
            <form id="auth-form" class="auth-form">
                <input type="email" id="email" placeholder="Email" required>
                <input type="password" id="password" placeholder="Hasło (min. 6 znaków)" required>
                <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700 font-semibold transition">Zatwierdź</button>
                <p id="auth-error" class="text-red-500 text-sm text-center mt-2"></p>
            </form>
            <p class="text-center mt-4 text-sm">
                <button id="toggle-auth-mode" class="text-blue-500 underline">Nie masz konta? Zarejestruj się</button>
            </p>
        </div>

        <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 hidden"></div>
        
        <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
            <span id="save-status">Stan: Lokalny</span> | Dane przechowywane w Google Firebase.
        </footer>
    </div>

    <script type="module">
        // 1. IMPORT FIREBASE (Wersja Modularna)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // -----------------------------------------------------------
        // 2. KONFIGURACJA FIREBASE (Twoje dane)
        // -----------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyAV5MvDejW_cefwyx-ZeBKqWcjUveyYEs0",
            authDomain: "hybridworker.firebaseapp.com",
            projectId: "hybridworker",
            storageBucket: "hybridworker.firebasestorage.app",
            messagingSenderId: "1077197503232",
            appId: "1:1077197503232:web:e22cf7b58264024bb051e5",
            measurementId: "G-T8T1JM3RMS"
        };
        // -----------------------------------------------------------

        // Inicjalizacja Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Zmienne globalne stanu
        let user = null; 
        const MIN_YEAR = 2025;
        const MAX_YEAR = 2035;
        let currentYear = new Date().getFullYear();
        if (currentYear < MIN_YEAR) currentYear = MIN_YEAR;
        
        // Dane kalendarza
        let appState = {
            target: 0.40,
            office: [],
            vacation: []
        };
        
        let vacationModes = new Array(12).fill(false);
        const MONTHS = ["Styczeń", "Luty", "Marzec", "Kwiecień", "Maj", "Czerwiec", "Lipiec", "Sierpień", "Wrzesień", "Październik", "Listopad", "Grudzień"];

        // --- AUTHENTICATION LOGIC ---

        const authBar = document.getElementById('auth-bar');
        const authContainer = document.getElementById('auth-container');
        const appInterface = document.getElementById('app-interface');
        const calendarGrid = document.getElementById('calendar-grid');
        const authForm = document.getElementById('auth-form');
        const authTitle = document.getElementById('auth-title');
        const toggleAuthBtn = document.getElementById('toggle-auth-mode');
        const errorMsg = document.getElementById('auth-error');

        let isLoginMode = true;

        // Nasłuchiwanie stanu logowania
        onAuthStateChanged(auth, (currentUser) => {
            user = currentUser;
            if (user) {
                // Zalogowany
                console.log("Zalogowano:", user.email);
                showApp();
                loadDataFromFirebase();
            } else {
                // Wylogowany
                console.log("Wylogowano");
                showLogin();
                // Wyczyść dane wizualnie
                appState = { target: 0.40, office: [], vacation: [] };
                renderCalendar();
            }
            updateAuthUI();
        });

        function updateAuthUI() {
            if (user) {
                authBar.innerHTML = `
                    <span class="mr-3 text-slate-600">Zalogowano: <b>${user.email}</b></span>
                    <button id="btn-logout" class="text-red-500 hover:underline">Wyloguj</button>
                `;
                document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));
                document.getElementById('save-status').innerText = "Stan: Zapisano w chmurze";
                document.getElementById('save-status').className = "text-green-600 font-bold";
            } else {
                authBar.innerHTML = `<span class="text-slate-400">Niezalogowany (tryb podglądu)</span>`;
                document.getElementById('save-status').innerText = "Stan: Niezapisany";
                document.getElementById('save-status').className = "text-slate-400";
            }
        }

        function showApp() {
            authContainer.classList.add('hidden');
            appInterface.classList.remove('hidden');
            calendarGrid.classList.remove('hidden');
        }

        function showLogin() {
            authContainer.classList.remove('hidden');
            appInterface.classList.add('hidden');
            calendarGrid.classList.add('hidden');
        }

        toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            isLoginMode = !isLoginMode;
            authTitle.innerText = isLoginMode ? "Zaloguj się" : "Utwórz konto";
            toggleAuthBtn.innerText = isLoginMode ? "Nie masz konta? Zarejestruj się" : "Masz już konto? Zaloguj się";
            errorMsg.innerText = "";
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            errorMsg.innerText = "Przetwarzanie...";

            try {
                if (isLoginMode) {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    await createUserWithEmailAndPassword(auth, email, password);
                }
            } catch (error) {
                console.error(error);
                let msg = "Wystąpił błąd.";
                if (error.code === 'auth/invalid-credential') msg = "Błędne hasło lub email.";
                if (error.code === 'auth/email-already-in-use') msg = "Ten email jest już zajęty.";
                if (error.code === 'auth/weak-password') msg = "Hasło jest za słabe (min. 6 znaków).";
                errorMsg.innerText = msg;
            }
        });

        // --- DATABASE LOGIC (FIRESTORE) ---

        async function loadDataFromFirebase() {
            if (!user) return;
            const docRef = doc(db, "users", user.uid, "years", currentYear.toString());
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    appState.target = data.target || 0.40;
                    appState.office = data.office || [];
                    appState.vacation = data.vacation || [];
                } else {
                    // Brak danych dla tego roku - reset
                    appState.office = [];
                    appState.vacation = [];
                }
                updateSelectors();
                renderCalendar();
                updateStats();
            } catch (e) {
                console.error("Błąd pobierania danych:", e);
            }
        }

        async function saveDataToFirebase() {
            if (!user) return;
            document.getElementById('save-status').innerText = "Zapisywanie...";
            const docRef = doc(db, "users", user.uid, "years", currentYear.toString());
            try {
                await setDoc(docRef, {
                    target: appState.target,
                    office: appState.office,
                    vacation: appState.vacation,
                    updatedAt: new Date()
                });
                document.getElementById('save-status').innerText = "Stan: Zapisano w chmurze";
                setTimeout(() => document.getElementById('save-status').innerText = "Stan: Zsynchronizowany", 2000);
            } catch (e) {
                console.error("Błąd zapisu:", e);
                document.getElementById('save-status').innerText = "Błąd zapisu!";
            }
        }

        // --- CALENDAR LOGIC (Standard JS) ---

        function initSelectors() {
            const ySel = document.getElementById('year-selector');
            ySel.innerHTML = '';
            for(let y=MIN_YEAR; y<=MAX_YEAR; y++) {
                let opt = document.createElement('option');
                opt.value = y; opt.text = y;
                if(y === currentYear) opt.selected = true;
                ySel.appendChild(opt);
            }
            ySel.addEventListener('change', (e) => {
                currentYear = parseInt(e.target.value);
                loadDataFromFirebase(); // Reload for new year
            });

            const tSel = document.getElementById('target-selector');
            tSel.innerHTML = '';
            for(let i=0; i<=100; i+=5) {
                let opt = document.createElement('option');
                opt.value = (i/100).toFixed(2);
                opt.text = i + "%";
                tSel.appendChild(opt);
            }
            tSel.addEventListener('change', (e) => {
                appState.target = parseFloat(e.target.value);
                updateStats();
                renderCalendar();
                saveDataToFirebase();
            });
        }

        function updateSelectors() {
            // Update UI selectors based on loaded state
            const tSel = document.getElementById('target-selector');
            for(let opt of tSel.options) {
                if(Math.abs(parseFloat(opt.value) - appState.target) < 0.01) opt.selected = true;
            }
        }

        function getHolidays(year) {
            // Proste święta stałe
            const h = [`${year}-01-01`, `${year}-01-06`, `${year}-05-01`, `${year}-05-03`, `${year}-08-15`, `${year}-11-01`, `${year}-11-11`, `${year}-12-25`, `${year}-12-26`];
            // Wielkanoc (uproszczona Gaussa)
            const a = year % 19, b = Math.floor(year / 100), c = year % 100;
            const d = Math.floor(b / 4), e = b % 4, f = Math.floor((b + 8) / 25);
            const g = Math.floor((b - f + 1) / 3), h_ = (19 * a + b - d - g + 15) % 30;
            const i = Math.floor(c / 4), k = c % 4, l = (32 + 2 * e + 2 * i - h_ - k) % 7;
            const m = Math.floor((a + 11 * h_ + 22 * l) / 451);
            const p = (h_ + l - 7 * m + 114);
            const month = Math.floor(p / 31) - 1, day = (p % 31) + 1;
            const easter = new Date(year, month, day);
            
            const fmt = d => d.toISOString().split('T')[0];
            const add = (d, n) => { const x = new Date(d); x.setDate(x.getDate()+n); return x; };
            
            h.push(fmt(easter));
            h.push(fmt(add(easter, 1))); // Poniedziałek Wielkanocny
            h.push(fmt(add(easter, 60))); // Boże Ciało
            return h;
        }

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const holidays = getHolidays(currentYear);

            MONTHS.forEach((name, mIdx) => {
                const daysInMonth = new Date(currentYear, mIdx + 1, 0).getDate();
                const firstDayOffset = new Date(currentYear, mIdx, 1).getDay() || 7; // 1=Mon, 7=Sun
                
                // Karta miesiąca
                const card = document.createElement('div');
                card.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden p-4";
                
                // Nagłówek miesiąca
                const header = document.createElement('div');
                header.className = "flex justify-between items-center mb-4";
                header.innerHTML = `<h3 class="font-bold">${name}</h3>`;
                
                // Przełączniki trybu
                const modeDiv = document.createElement('div');
                modeDiv.className = "flex gap-2 text-xs mb-4";
                const btnOffice = document.createElement('button');
                btnOffice.textContent = "Biuro";
                btnOffice.className = `flex-1 py-1 rounded border ${!vacationModes[mIdx] ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-slate-500'}`;
                btnOffice.onclick = () => { vacationModes[mIdx] = false; renderCalendar(); };
                
                const btnVacation = document.createElement('button');
                btnVacation.textContent = "Urlop";
                btnVacation.className = `flex-1 py-1 rounded border ${vacationModes[mIdx] ? 'bg-amber-400 text-amber-900 border-amber-500' : 'bg-white text-slate-500'}`;
                btnVacation.onclick = () => { vacationModes[mIdx] = true; renderCalendar(); };
                
                modeDiv.append(btnOffice, btnVacation);

                // Siatka dni
                const daysGrid = document.createElement('div');
                daysGrid.className = "grid grid-cols-7 gap-1 text-sm text-center";
                
                // Puste pola na początek
                for(let i=1; i<firstDayOffset; i++) daysGrid.appendChild(document.createElement('div'));

                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(currentYear, mIdx, d);
                    const dateStr = dateObj.toISOString().split('T')[0];
                    const dayOfWeek = dateObj.getDay();
                    const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
                    const isHoliday = holidays.includes(dateStr);
                    
                    const cell = document.createElement('div');
                    cell.textContent = d;
                    cell.className = "aspect-square flex items-center justify-center rounded cursor-pointer select-none day-cell relative ";
                    
                    if(isHoliday) {
                        cell.className += "bg-red-50 text-red-400 border border-red-100 cursor-not-allowed";
                    } else if(isWeekend) {
                        cell.className += "bg-slate-100 text-slate-400 cursor-default";
                    } else {
                        // Dzień roboczy
                        const isOff = appState.office.includes(dateStr);
                        const isVac = appState.vacation.includes(dateStr);
                        
                        if(isOff) cell.className += "bg-green-500 text-white shadow-md border border-green-600";
                        else if(isVac) cell.className += "bg-amber-300 text-amber-900 border border-amber-400";
                        else cell.className += "bg-white border border-slate-200 hover:border-blue-300";

                        cell.onclick = () => toggleDay(dateStr, mIdx);
                    }
                    daysGrid.appendChild(cell);
                }

                card.append(header, modeDiv, daysGrid);
                grid.appendChild(card);
            });
            updateStats();
        }

        function toggleDay(dateStr, mIdx) {
            if(!user) return; // Zablokuj edycję jeśli niezalogowany

            const isVacMode = vacationModes[mIdx];
            
            if(isVacMode) {
                // Tryb urlopowy
                if(appState.vacation.includes(dateStr)) {
                    appState.vacation = appState.vacation.filter(d => d !== dateStr);
                } else {
                    appState.vacation.push(dateStr);
                    appState.office = appState.office.filter(d => d !== dateStr); // Usuń biuro jeśli dodano urlop
                }
            } else {
                // Tryb biurowy
                if(appState.office.includes(dateStr)) {
                    appState.office = appState.office.filter(d => d !== dateStr);
                } else {
                    appState.office.push(dateStr);
                    appState.vacation = appState.vacation.filter(d => d !== dateStr); // Usuń urlop jeśli dodano biuro
                }
            }
            renderCalendar();
            saveDataToFirebase(); // Auto-save
        }

        function updateStats() {
            // Uproszczona logika statystyk dla zwięzłości
            const holidays = getHolidays(currentYear);
            let totalWorking = 0;
            
            // Policz dni robocze w roku
            for(let m=0; m<12; m++) {
                const daysInMonth = new Date(currentYear, m+1, 0).getDate();
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(currentYear, m, d);
                    const s = date.toISOString().split('T')[0];
                    const w = date.getDay();
                    if(w !== 0 && w !== 6 && !holidays.includes(s)) {
                        totalWorking++;
                    }
                }
            }
            
            // Odejmij zaplanowane urlopy (tylko te w dni robocze)
            const validVacations = appState.vacation.filter(d => {
                const dt = new Date(d);
                const w = dt.getDay();
                return w !== 0 && w !== 6 && !holidays.includes(d);
            }).length;

            const effectiveWorking = totalWorking - validVacations;
            const required = Math.ceil(effectiveWorking * appState.target);
            
            document.getElementById('stat-working').textContent = effectiveWorking;
            document.getElementById('stat-required').textContent = required;
            
            const selected = appState.office.length;
            const selEl = document.getElementById('stat-selected');
            selEl.textContent = selected;
            selEl.className = selected >= required ? "text-xl font-bold text-green-600" : "text-xl font-bold text-slate-700";
        }

        // START
        initSelectors();
        renderCalendar(); // Renderuj pusty na start

        // Jeśli niezalogowany przy starcie
        if(!user) showLogin();
        
        // Expose toggle globally for debugging if needed
        window.toggleDay = toggleDay; 
    </script>
</body>
</html>
