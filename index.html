<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Kalkulator i planer pracy hybrydowej (2025-2035).">
    <meta name="author" content="Hybrid Work Planner">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“…</text></svg>">
    
    <title>Planer Pracy Hybrydowej</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .day-cell { transition: all 0.15s ease-out; }
        .day-cell:hover:not(.disabled) { transform: scale(1.15); z-index: 10; cursor: pointer; }

        .year-select {
            /* ... (bez zmian) ... */
            background: transparent;
            border: none;
            color: inherit;
            font-weight: inherit;
            font-size: inherit;
            cursor: pointer;
            border-bottom: 2px solid #bfdbfe;
            padding: 0 0.2em;
            outline: none;
            appearance: none;
            -webkit-appearance: none;
            text-align: center;
        }
        .year-select:hover { border-bottom-color: #60a5fa; }
        .year-select:focus { background-color: #eff6ff; border-radius: 4px; }

        /* Style for Auth forms */
        .auth-form input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
            margin-bottom: 15px;
        }
        .auth-form button {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            transition: background 0.2s;
        }
        
        @media print {
            body { background: white; padding: 0; }
            .max-w-7xl { max-width: 100%; }
            .shadow-sm, .shadow-md { box-shadow: none !important; }
            button, select, .mode-buttons, .auth-controls { display: none !important; }
            h1::after { content: " " attr(data-year); }
            #calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
            .day-cell { border: 1px solid #ddd; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            
            <div id="auth-controls" class="auth-controls flex justify-end mb-4 text-sm">
                </div>
            
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 mb-2 flex justify-center items-center gap-2 flex-wrap" id="main-title">
                Kalendarz Pracy Hybrydowej 
                <div class="relative inline-block">
                    <select id="year-selector" onchange="changeYear(this.value)" class="year-select text-blue-600">
                        </select>
                </div>
            </h1>
            <p class="text-slate-600 mb-4 flex justify-center items-center gap-2">
                Planer obecnoÅ›ci. Cel: 
                <span class="relative inline-block">
                    <select id="target-selector" onchange="changeTarget(this.value)" class="appearance-none font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-200 hover:border-blue-400 cursor-pointer focus:outline-none focus:bg-blue-100 rounded px-2 py-0.5 text-center transition-all pr-6">
                        </select>
                    <span class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400 text-xs">â–¼</span>
                </span>
                efektywnych dni pracy.
            </p>
            
            <div id="main-content" class="mt-8">
                <div id="stats-container" class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Do przepracowania <span class="current-year-display"></span></div>
                        <div class="text-xl font-bold text-slate-700" id="year-working-days">0</div>
                        <div class="text-xs text-slate-400 font-normal">(po odjÄ™ciu urlopÃ³w)</div>
                    </div>
                    <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Cel biurowy (<span id="summary-target-label">40%</span>)</div>
                        <div class="text-xl font-bold text-blue-600" id="year-required-days">0</div>
                    </div>
                    <div>
                        <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Zaplanowane w biurze</div>
                        <div class="text-xl font-bold text-green-600" id="year-selected-days">0</div>
                    </div>
                </div>

                <div class="mt-4 text-sm text-slate-400 text-center">
                    <button onclick="clearAll()" class="text-red-400 hover:text-red-600 underline text-xs">Zresetuj kalendarz dla roku <span class="current-year-display"></span></button>
                </div>
            </div>
            
        </header>
        
        <div id="auth-container" class="hidden max-w-lg mx-auto bg-white p-8 rounded-xl shadow-md border border-slate-200">
            </div>

        <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            </div>

        <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
            Dane domyÅ›lnie zapisujÄ… siÄ™ w pamiÄ™ci przeglÄ…darki. Po zalogowaniu zapisywane sÄ… na serwerze.<br>
            Korekta: -1 dzieÅ„ pracy za Å›wiÄ™to przypadajÄ…ce w sobotÄ™ (z dodatkowÄ… poprawkÄ… dla grudnia 2026).
        </footer>
    </div>

    <script>
        // --- Configuration & Helpers ---
        // ... (staÅ‚e) ...

        // --- AUTENTYKACJA (Frontend) ---
        let isAuthenticated = false;
        let currentUserEmail = null;
        
        // Prawdziwe API bÄ™dzie wymagaÅ‚o implementacji backendu!
        const API_BASE_URL = '/api/v1'; // Docelowy endpoint API

        /**
         * Pobiera token z LocalStorage (symulacja)
         * @returns {string|null}
         */
        function getUserToken() {
            return localStorage.getItem('userToken'); 
        }

        /**
         * OdÅ›wieÅ¼a status logowania, pobiera token i e-mail uÅ¼ytkownika.
         * @returns {void}
         */
        function initAuth() {
            const token = getUserToken();
            isAuthenticated = !!token;
            // W prawdziwej aplikacji: token musi byÄ‡ zweryfikowany na serwerze.
            // Tutaj symulujemy, Å¼e e-mail jest zapisany razem z tokenem, lub odkodowujemy JWT
            currentUserEmail = localStorage.getItem('userEmail'); 
            
            renderAuthControls();
            
            // Po wczytaniu statusu, Å‚adujemy stan kalendarza
            loadState(); 
        }

        /**
         * Renderuje przyciski logowania/wylogowania w nagÅ‚Ã³wku.
         */
        function renderAuthControls() {
            const controls = document.getElementById('auth-controls');
            
            if (isAuthenticated) {
                controls.innerHTML = `
                    <span class="text-green-600 font-semibold mr-4 flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5.121 17.804A13.937 13.937 0 0112 16c2.5 0 4.847.655 6.879 1.804M15 10a3 3 0 11-6 0 3 3 0 016 0zm6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        ${currentUserEmail || 'UÅ¼ytkownik'}
                    </span>
                    <button onclick="handleLogout()" class="text-blue-500 hover:text-blue-700">Wyloguj</button>
                `;
                // Ukrywamy formularz, pokazujemy kalendarz
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
            } else {
                controls.innerHTML = `
                    <button onclick="renderAuthScreen('login')" class="text-blue-500 hover:text-blue-700 mr-2">Zaloguj</button>
                    <button onclick="renderAuthScreen('register')" class="text-blue-500 hover:text-blue-700 font-semibold">Zarejestruj</button>
                `;
                // JeÅ›li niezalogowany, ukrywamy kalendarz i pokazujemy formularz
                document.getElementById('auth-container').classList.remove('hidden');
                document.getElementById('main-content').classList.add('hidden');
                // JeÅ›li nie ma tokenu, automatycznie wyÅ›wietlamy formularz logowania
                renderAuthScreen('login');
            }
        }
        
        /**
         * WyÅ›wietla formularz logowania lub rejestracji.
         * @param {'login'|'register'} mode
         */
        function renderAuthScreen(mode) {
            const container = document.getElementById('auth-container');
            container.classList.remove('hidden');
            document.getElementById('calendar-grid').innerHTML = ''; // CzyÅ›cimy kalendarz
            
            let title = mode === 'login' ? 'Logowanie' : 'Rejestracja';
            let actionText = mode === 'login' ? 'Zaloguj siÄ™' : 'UtwÃ³rz konto';
            let switchMode = mode === 'login' ? 'register' : 'login';
            let switchText = mode === 'login' ? 'Nie masz konta? Zarejestruj siÄ™.' : 'Masz juÅ¼ konto? Zaloguj siÄ™.';
            let actionFunction = mode === 'login' ? 'handleLogin(event)' : 'handleRegister(event)';
            
            container.innerHTML = `
                <h2 class="text-2xl font-bold text-center mb-6 text-blue-800">${title}</h2>
                <form class="auth-form" onsubmit="${actionFunction}">
                    <input type="email" id="${mode}-email" placeholder="Email" required>
                    <input type="password" id="${mode}-password" placeholder="HasÅ‚o" required>
                    <button type="submit" class="w-full bg-blue-600 text-white hover:bg-blue-700">${actionText}</button>
                    <p id="auth-message" class="text-center mt-3 text-sm"></p>
                </form>
                <p class="text-center mt-4 text-slate-500 text-sm">
                    <a href="#" onclick="event.preventDefault(); renderAuthScreen('${switchMode}')" class="text-blue-500 hover:underline">${switchText}</a>
                </p>
            `;
            // Ukrywamy gÅ‚Ã³wne statystyki, gdy jesteÅ›my na ekranie uwierzytelniania
            document.getElementById('stats-container').classList.add('hidden');
        }

        /**
         * ObsÅ‚uguje proces logowania (wysyÅ‚anie danych do API).
         * @param {Event} event
         */
        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const msgEl = document.getElementById('auth-message');
            msgEl.className = 'text-center mt-3 text-sm text-slate-500';
            msgEl.innerText = 'Trwa logowanie...';

            // --- POCZÄ„TEK KOMUNIKACJI Z API BACKENDU ---
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // PomyÅ›lne logowanie: Zapisz token i email (symulacja)
                    localStorage.setItem('userToken', data.token);
                    localStorage.setItem('userEmail', email);
                    isAuthenticated = true;
                    currentUserEmail = email;
                    
                    msgEl.className = 'text-center mt-3 text-sm text-green-600 font-semibold';
                    msgEl.innerText = 'Logowanie udane! Åadowanie kalendarza...';
                    
                    // OdÅ›wieÅ¼ widok
                    renderAuthControls();
                    document.getElementById('stats-container').classList.remove('hidden');
                    // Ponowne wczytanie stanu (tym razem z serwera)
                    loadState(); 
                    renderCalendar();
                } else {
                    // Nieudane logowanie
                    msgEl.className = 'text-center mt-3 text-sm text-red-600 font-semibold';
                    msgEl.innerText = data.message || 'BÅ‚Ä…d logowania. SprawdÅº e-mail i hasÅ‚o.';
                }
            } catch (error) {
                console.error("BÅ‚Ä…d sieci podczas logowania:", error);
                msgEl.className = 'text-center mt-3 text-sm text-red-600 font-semibold';
                msgEl.innerText = 'BÅ‚Ä…d poÅ‚Ä…czenia z serwerem.';
            }
        }
        
        /**
         * ObsÅ‚uguje proces rejestracji (wysyÅ‚anie danych do API).
         * @param {Event} event
         */
        async function handleRegister(event) {
            event.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const msgEl = document.getElementById('auth-message');
            msgEl.className = 'text-center mt-3 text-sm text-slate-500';
            msgEl.innerText = 'Trwa rejestracja...';

            // --- POCZÄ„TEK KOMUNIKACJI Z API BACKENDU ---
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    msgEl.className = 'text-center mt-3 text-sm text-green-600 font-semibold';
                    msgEl.innerText = 'Rejestracja udana! MoÅ¼esz siÄ™ zalogowaÄ‡.';
                    // PrzeÅ‚Ä…cz na widok logowania po rejestracji
                    setTimeout(() => renderAuthScreen('login'), 1000);
                } else {
                    msgEl.className = 'text-center mt-3 text-sm text-red-600 font-semibold';
                    msgEl.innerText = data.message || 'BÅ‚Ä…d rejestracji. UÅ¼ytkownik moÅ¼e juÅ¼ istnieÄ‡.';
                }
            } catch (error) {
                console.error("BÅ‚Ä…d sieci podczas rejestracji:", error);
                msgEl.className = 'text-center mt-3 text-sm text-red-600 font-semibold';
                msgEl.innerText = 'BÅ‚Ä…d poÅ‚Ä…czenia z serwerem.';
            }
        }
        
        /**
         * ObsÅ‚uguje wylogowanie (usuniÄ™cie tokenu i powrÃ³t do widoku logowania).
         */
        function handleLogout() {
            if (confirm("Czy na pewno chcesz siÄ™ wylogowaÄ‡?")) {
                localStorage.removeItem('userToken');
                localStorage.removeItem('userEmail');
                isAuthenticated = false;
                currentUserEmail = null;
                // WyczyÅ›Ä‡ stan kalendarza po wylogowaniu
                officeDays = [];
                vacationDays = [];
                
                renderAuthControls(); // PrzeÅ‚Ä…czenie na widok logowania
                updateYearlyStats(); // OdÅ›wieÅ¼ statystyki do zera
            }
        }
        // --- KONIEC AUTENTYKACJI (Frontend) ---


        // --- Komunikacja API i Zapis Danych ---

        /**
         * Åaduje stan kalendarza z serwera (jeÅ›li zalogowany) lub lokalnie (jeÅ›li wylogowany).
         */
        async function loadState() {
            holidaysCache = calculateHolidays(currentYear);
            vacationModes = new Array(12).fill(false);

            if (isAuthenticated) {
                await loadStateFromAPI(currentYear);
            } else {
                // FALLBACK: Åadowanie z LocalStorage dla wylogowanych
                targetPercentage = parseFloat(localStorage.getItem(`targetPercentage_${currentYear}`)) || 0.40;
                officeDays = JSON.parse(localStorage.getItem(`officeDays_${currentYear}`)) || [];
                vacationDays = JSON.parse(localStorage.getItem(`vacationDays_${currentYear}`)) || [];
            }
            // Zapewnienie, Å¼e po zaÅ‚adowaniu stanÃ³w (czy to z API, czy lokalnie) sÄ… one odzwierciedlone w selectorach
            initTargetSelector(); 
        }

        async function loadStateFromAPI(year) {
            try {
                const response = await fetch(`${API_BASE_URL}/calendar/${year}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${getUserToken()}` 
                    }
                });

                if (!response.ok) {
                    console.warn(`BÅ‚Ä…d serwera podczas Å‚adowania stanu dla roku ${year}. UÅ¼yto stanu domyÅ›lnego/czystego.`);
                    // JeÅ›li nie ma danych, uÅ¼ywamy domyÅ›lnego czystego stanu
                    targetPercentage = 0.40;
                    officeDays = [];
                    vacationDays = [];
                    return;
                }

                const data = await response.json();
                
                // Zaktualizuj stan aplikacji danymi z serwera
                targetPercentage = data.target_percentage || 0.40;
                officeDays = data.office_days || [];
                vacationDays = data.vacation_days || [];
                
            } catch (error) {
                console.error("Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ stanu z API:", error);
                targetPercentage = 0.40;
                officeDays = [];
                vacationDays = [];
            }
        }

        /**
         * Zapisuje stan kalendarza na serwerze (jeÅ›li zalogowany) lub lokalnie (jeÅ›li wylogowany).
         */
        async function saveState() {
            if (isAuthenticated) {
                await saveStateToAPI();
            } else {
                // FALLBACK: Zapis do LocalStorage dla wylogowanych
                localStorage.setItem(`officeDays_${currentYear}`, JSON.stringify(officeDays));
                localStorage.setItem(`vacationDays_${currentYear}`, JSON.stringify(vacationDays));
                localStorage.setItem(`targetPercentage_${currentYear}`, targetPercentage);
            }
            updateYearlyStats();
        }

        async function saveStateToAPI() {
            const payload = {
                year: currentYear,
                target_percentage: targetPercentage,
                office_days: officeDays,
                vacation_days: vacationDays
            };

            try {
                const response = await fetch(`${API_BASE_URL}/calendar/${currentYear}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getUserToken()}`
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('BÅ‚Ä…d zapisu danych na serwerze.');
                }

                console.log("Stan kalendarza zapisany pomyÅ›lnie.");

            } catch (error) {
                console.error("BÅ‚Ä…d podczas zapisywania do API:", error);
                // W prawdziwej aplikacji: naleÅ¼y zajÄ…Ä‡ siÄ™ odÅ›wieÅ¼eniem tokenu
                alert("BÅ‚Ä…d zapisu! Upewnij siÄ™, Å¼e jesteÅ› zalogowany.");
            }
        }
        
        // --- POZOSTAÅE FUNKCJE KALENDARZA (Wymagane zmiany) ---
        
        function changeYear(val) {
            currentYear = parseInt(val);
            document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
            document.getElementById('main-title').setAttribute('data-year', currentYear);
            
            // Funkcja loadState jest teraz asynchroniczna i wywoÅ‚uje renderCalendar!
            loadState().then(() => {
                updateYearlyStats();
                renderCalendar();
            });
        }

        function changeTarget(val) {
            targetPercentage = parseFloat(val);
            saveState(); // Teraz saveState jest async
            updateYearlyStats();
            renderCalendar();
        }
        
        // Zmiana toggleDay na funkcjÄ™ asynchronicznÄ…, aby czekaÅ‚a na zapis
        async function toggleDay(dateStr, monthIndex) {
            const isVacationMode = vacationModes[monthIndex];
            const date = new Date(dateStr);
            
            if (isWeekend(date) || (holidaysCache.includes(dateStr) && dateStr !== `${currentYear}-12-24`)) return;

            if (isVacationMode) {
                if (vacationDays.includes(dateStr)) {
                    vacationDays = vacationDays.filter(d => d !== dateStr);
                } else {
                    vacationDays.push(dateStr);
                    officeDays = officeDays.filter(d => d !== dateStr);
                }
            } else {
                if (officeDays.includes(dateStr)) {
                    officeDays = officeDays.filter(d => d !== dateStr);
                } else {
                    officeDays.push(dateStr);
                    vacationDays = vacationDays.filter(d => d !== dateStr);
                }
            }
            await saveState(); // Czekamy na trwaÅ‚y zapis
            renderCalendar();
        }

        async function clearAll() {
            if (isAuthenticated) {
                if(confirm(`Czy na pewno chcesz wyczyÅ›ciÄ‡ stan kalendarza na serwerze dla roku ${currentYear}?`)) {
                    officeDays = [];
                    vacationDays = [];
                    await saveState();
                    renderCalendar();
                }
            } else {
                if(confirm(`Czy na pewno chcesz wyczyÅ›ciÄ‡ kalendarz lokalnie dla roku ${currentYear}?`)) {
                    officeDays = [];
                    vacationDays = [];
                    await saveState();
                    renderCalendar();
                }
            }
        }
        // ... (PozostaÅ‚e funkcje: isWeekend, getMonthData, updateYearlyStats, renderCalendar - bez zmian logiki biznesowej, tylko kosmetyczne) ...

        // Initialize (Wymagane zmiany w inicjalizacji)
        initYearSelector();
        initAuth(); // Nowy punkt startowy!
        // initTargetSelector() -> przeniesione do loadState()
        // updateYearlyStats() -> wywoÅ‚ywane w initAuth -> loadState -> saveState
        // renderCalendar() -> wywoÅ‚ywane w initAuth -> loadState
        
    </script>
</body>
</html>
