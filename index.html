<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Planer Pracy Hybrydowej (Zaloguj/Planuj)</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
body { font-family: 'Inter', sans-serif; }
.day-cell { transition: all 0.15s ease-out; }
.day-cell:hover:not(.disabled) { transform: scale(1.15); z-index: 10; cursor: pointer; }

.year-select {
background: transparent;
border: none;
color: inherit;
font-weight: inherit;
font-size: inherit;
cursor: pointer;
border-bottom: 2px solid #bfdbfe;
padding: 0 0.2em;
outline: none;
appearance: none;
-webkit-appearance: none;
text-align: center;
}
.year-select:hover { border-bottom-color: #60a5fa; }
.year-select:focus { background-color: #eff6ff; border-radius: 4px; }

/* Ukryj widok kalendarza, gdy u≈ºytkownik nie jest zalogowany */
#calendar-app { display: none; } 

/* Styl dla ≈Çadowania */
#loading-indicator {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    z-index: 1000;
    display: none;
}

/* Animacja przycisku Google */
#google-auth-btn:disabled {
    opacity: 0.7;
    cursor: not-allowed;
}

#google-auth-btn:not(:disabled):hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

@media print {
body { background: white; padding: 0; }
.max-w-7xl { max-width: 100%; }
.shadow-sm, .shadow-md { box-shadow: none !important; }
button, select, .mode-buttons { display: none !important; }
h1::after { content: " " attr(data-year); }
#calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }
.day-cell { border: 1px solid #ddd; }
}
</style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

<div id="loading-indicator">
    <div class="text-center">
        <svg class="animate-spin h-6 w-6 text-blue-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm text-slate-600" id="loading-text">≈Åadowanie danych...</p>
    </div>
</div>

<div id="auth-screen" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-xl shadow-2xl border border-slate-200">
    <h2 class="text-3xl font-bold text-blue-800 mb-6 text-center" id="auth-title">Zaloguj siƒô</h2>
    <div id="auth-error" class="text-red-600 mb-4 text-center hidden p-3 bg-red-50 rounded-lg border border-red-200"></div>
    
    <input type="email" id="auth-email" placeholder="Adres E-mail" class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
    <input type="password" id="auth-password" placeholder="Has≈Ço" class="w-full p-3 mb-6 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
    
    <button id="auth-main-btn" onclick="handleAuth()" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        Zaloguj
    </button>
    
    <div class="mt-4 flex items-center justify-center">
        <div class="w-full border-t border-slate-200"></div>
        <div class="px-3 text-sm text-slate-400">LUB</div>
        <div class="w-full border-t border-slate-200"></div>
    </div>

    <button id="google-auth-btn" onclick="signInWithGoogle()" class="w-full py-3 mt-4 flex items-center justify-center bg-white text-slate-700 font-semibold rounded-lg border border-slate-300 hover:bg-slate-50 transition shadow-sm">
        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.4l6.62-6.5C34.33 3.6 29.47 2 24 2 15.3 2 7.76 6.13 3.96 12.55l7.98 6.19C13.25 14.54 18.06 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.5 24c0-1.64-.15-3.22-.42-4.74H24v9.49h12.7c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6C43.64 38.48 46.5 31.77 46.5 24z"/>
            <path fill="#FBBC05" d="M11.94 28.34c-.63-1.87-.99-3.86-.99-5.91s.36-4.04.99-5.91L3.96 10.33C1.96 14.16 1 18.41 1 23c0 4.59.96 8.84 2.96 12.67l7.98-7.33z"/>
            <path fill="#34A853" d="M24 47c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 40.53 14.54 47 24 47z"/>
        </svg>
        <span id="google-btn-text">Zaloguj przez Google</span>
    </button>
    
    <p class="text-center mt-6 text-sm">
        <button id="auth-toggle-btn" onclick="toggleAuthMode()" class="text-blue-500 hover:text-blue-700 font-medium">
            Nie masz konta? Zarejestruj siƒô!
        </button>
    </p>
</div>

<div id="calendar-app" class="max-w-7xl mx-auto">
    <header class="mb-8 text-center">
        <h1 class="text-3xl md:text-4xl font-bold text-blue-900 mb-2 flex justify-center items-center gap-2 flex-wrap" id="main-title">
            Kalendarz Pracy Hybrydowej 
            <div class="relative inline-block">
                <select id="year-selector" onchange="changeYear(this.value)" class="year-select text-blue-600">
                </select>
            </div>
        </h1>
        <p class="text-slate-600 mb-4 flex justify-center items-center gap-2">
            Planer obecno≈õci. Cel: 
            <span class="relative inline-block">
                <select id="target-selector" onchange="changeTarget(this.value)" class="appearance-none font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-200 hover:border-blue-400 cursor-pointer focus:outline-none focus:bg-blue-100 rounded px-2 py-0.5 text-center transition-all pr-6">
                </select>
                <span class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400 text-xs">‚ñº</span>
            </span>
            efektywnych dni pracy.
        </p>

        <div class="flex flex-wrap justify-center gap-4 text-sm bg-white p-3 rounded-xl shadow-sm inline-flex">
            <div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Dzie≈Ñ w biurze</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-amber-300 rounded mr-2"></div>Urlop / L4</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>Praca zdalna</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-slate-100 border border-slate-200 rounded mr-2"></div>Weekend</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-red-100 border border-red-200 text-red-800 rounded mr-2 flex justify-center items-center text-xs font-bold">!</div>≈öwiƒôto</div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-1 sm:grid-cols-3 gap-4 text-center">
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Do przepracowania <span class="current-year-display"></span></div>
                <div class="text-xl font-bold text-slate-700" id="year-working-days">0</div>
                <div class="text-xs text-slate-400 font-normal">(po odjƒôciu urlop√≥w)</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Cel biurowy (<span id="summary-target-label">40%</span>)</div>
                <div class="text-xl font-bold text-blue-600" id="year-required-days">0</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Zaplanowane w biurze</div>
                <div class="text-xl font-bold text-green-600" id="year-selected-days">0</div>
            </div>
        </div>

        <div class="mt-4 text-sm text-slate-400 text-center flex justify-center gap-4">
            <button onclick="clearAll()" class="text-red-400 hover:text-red-600 underline text-xs">Zresetuj kalendarz dla roku <span class="current-year-display"></span></button>
            <button onclick="signOutUser()" class="text-slate-400 hover:text-slate-600 underline text-xs">Wyloguj</button>
        </div>
    </header>

    <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
    </div>

    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
        Dane zapisujƒÖ siƒô w pamiƒôci na koncie Firebase u≈ºytkownika, dziƒôki Firestore. <br>
        <strong>Zasada oblicze≈Ñ:</strong> (Dni robocze - Urlopy) * % Celu = Wymagane dni (zaokrƒÖglane w g√≥rƒô).<br>
        Korekta: -1 dzie≈Ñ pracy za ≈õwiƒôto przypadajƒÖce w sobotƒô (z dodatkowƒÖ poprawkƒÖ dla grudnia 2026).
    </footer>
</div>

<script type="module">
// Importujemy funkcje Firebase
import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    signOut,
    GoogleAuthProvider, 
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult
} from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';

import { 
    getFirestore, 
    doc, 
    getDoc, 
    setDoc 
} from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';


// --- KONFIGURACJA FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyAV5MvDejW_cefwyx-ZeBKqWcjUveyYEs0",
    authDomain: "hybridworker.firebaseapp.com",
    projectId: "hybridworker",
    storageBucket: "hybridworker.firebasestorage.app",
    messagingSenderId: "1077197503232",
    appId: "1:1077197503232:web:e22cf7b58264024bb051e5",
    measurementId: "G-T8T1JM3RMS"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app); 

// --- KONFIGURACJA GOOGLE PROVIDER ---
const googleProvider = new GoogleAuthProvider();
googleProvider.addScope('email');
googleProvider.addScope('profile');
googleProvider.setCustomParameters({
    prompt: 'select_account' // Zawsze pokazuj wyb√≥r konta
});

// --- ZMIENNE KODU ---
const MIN_YEAR = 2025;
const MAX_YEAR = 2035;
const nowYear = new Date().getFullYear();
let currentYear = (nowYear >= MIN_YEAR && nowYear <= MAX_YEAR) ? nowYear : MIN_YEAR;

let targetPercentage = 0.40;
let holidaysCache = [];

const MONTH_NAMES = [
"Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec",
"Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"
];
const DAY_NAMES = ["Pn", "Wt", "≈ör", "Cz", "Pt", "Sb", "Nd"];

let officeDays = [];
let vacationDays = [];
let vacationModes = new Array(12).fill(false);

// --- UI / AUTORYZACJA ---
let isLoginMode = true; 
let currentUserID = null;
let isGoogleSignInInProgress = false; // Flaga zapobiegajƒÖca wielokrotnemu klikniƒôciu

const authScreen = document.getElementById('auth-screen');
const calendarApp = document.getElementById('calendar-app');
const authTitle = document.getElementById('auth-title');
const authMainBtn = document.getElementById('auth-main-btn');
const authToggleBtn = document.getElementById('auth-toggle-btn');
const authError = document.getElementById('auth-error');
const googleAuthBtn = document.getElementById('google-auth-btn');
const googleBtnText = document.getElementById('google-btn-text');
const loadingIndicator = document.getElementById('loading-indicator');
const loadingText = document.getElementById('loading-text');

function showLoading(text = '≈Åadowanie danych...') { 
    loadingText.textContent = text;
    loadingIndicator.style.display = 'block'; 
}
function hideLoading() { loadingIndicator.style.display = 'none'; }

function setGoogleButtonLoading(isLoading) {
    googleAuthBtn.disabled = isLoading;
    if (isLoading) {
        googleBtnText.textContent = 'Logowanie...';
        googleAuthBtn.classList.add('opacity-70');
    } else {
        googleBtnText.textContent = 'Zaloguj przez Google';
        googleAuthBtn.classList.remove('opacity-70');
    }
}

function toggleAuthMode() {
    isLoginMode = !isLoginMode;
    authTitle.innerText = isLoginMode ? "Zaloguj siƒô" : "Zarejestruj siƒô";
    authMainBtn.innerText = isLoginMode ? "Zaloguj" : "Zarejestruj";
    authToggleBtn.innerText = isLoginMode ? "Nie masz konta? Zarejestruj siƒô!" : "Masz ju≈º konto? Zaloguj siƒô!";
    authError.classList.add('hidden');
}

async function handleAuth() {
    const email = document.getElementById('auth-email').value;
    const password = document.getElementById('auth-password').value;
    authError.classList.add('hidden');
    authMainBtn.disabled = true;

    if (!email || !password) {
        showAuthError("Wype≈Çnij oba pola.");
        authMainBtn.disabled = false;
        return;
    }

    showLoading(isLoginMode ? 'Logowanie...' : 'Rejestracja...');
    try {
        if (isLoginMode) {
            await signInWithEmailAndPassword(auth, email, password);
        } else {
            await createUserWithEmailAndPassword(auth, email, password);
        }
    } catch (error) {
        console.error("B≈ÇƒÖd autoryzacji:", error.code, error.message);
        let message = "WystƒÖpi≈Ç b≈ÇƒÖd autoryzacji. Spr√≥buj ponownie.";
        
        switch(error.code) {
            case 'auth/wrong-password':
            case 'auth/user-not-found':
            case 'auth/invalid-credential':
                message = "Nieprawid≈Çowy e-mail lub has≈Ço.";
                break;
            case 'auth/email-already-in-use':
                message = "Ten e-mail jest ju≈º zajƒôty. Spr√≥buj siƒô zalogowaƒá.";
                break;
            case 'auth/weak-password':
                message = "Has≈Ço musi mieƒá co najmniej 6 znak√≥w.";
                break;
            case 'auth/invalid-email':
                message = "Nieprawid≈Çowy format adresu e-mail.";
                break;
            case 'auth/too-many-requests':
                message = "Zbyt wiele pr√≥b. Poczekaj chwilƒô i spr√≥buj ponownie.";
                break;
            case 'auth/network-request-failed':
                message = "B≈ÇƒÖd sieci. Sprawd≈∫ po≈ÇƒÖczenie internetowe.";
                break;
        }
        showAuthError(message);
    } finally {
        authMainBtn.disabled = false;
        hideLoading();
    }
}

// --- POPRAWIONE LOGOWANIE GOOGLE ---
async function signInWithGoogle() {
    // Zapobiegaj wielokrotnemu klikniƒôciu
    if (isGoogleSignInInProgress) {
        console.log("Logowanie Google ju≈º w toku...");
        return;
    }
    
    isGoogleSignInInProgress = true;
    authError.classList.add('hidden');
    setGoogleButtonLoading(true);

    try {
        console.log("üîÑ Rozpoczynam logowanie przez Google (popup)...");
        
        const result = await signInWithPopup(auth, googleProvider);
        
        // Sukces - logowanie obs≈Çu≈ºy onAuthStateChanged
        console.log("‚úÖ Zalogowano przez Google:", result.user.email);
        
    } catch (error) {
        console.error("‚ùå B≈ÇƒÖd Google Auth:", error.code, error.message);
        
        let message = "WystƒÖpi≈Ç b≈ÇƒÖd logowania przez Google.";
        let shouldTryRedirect = false;
        
        switch(error.code) {
            case 'auth/popup-closed-by-user':
                message = "Okno logowania zosta≈Ço zamkniƒôte. Spr√≥buj ponownie.";
                break;
                
            case 'auth/cancelled-popup-request':
                message = "Anulowano poprzedniƒÖ pr√≥bƒô. Kliknij ponownie.";
                break;
                
            case 'auth/popup-blocked':
                message = "Popup zablokowany! Pr√≥bujƒô alternatywnƒÖ metodƒô...";
                shouldTryRedirect = true;
                break;
                
            case 'auth/operation-not-allowed':
                message = "‚ö†Ô∏è Logowanie Google nie jest w≈ÇƒÖczone w Firebase Console. Skontaktuj siƒô z administratorem.";
                break;
                
            case 'auth/account-exists-with-different-credential':
                message = "Konto z tym emailem ju≈º istnieje (u≈ºyj innej metody logowania).";
                break;
                
            case 'auth/network-request-failed':
                message = "B≈ÇƒÖd sieci. Sprawd≈∫ po≈ÇƒÖczenie internetowe.";
                break;
                
            case 'auth/unauthorized-domain':
                message = "‚ö†Ô∏è Ta domena nie jest autoryzowana. Skontaktuj siƒô z administratorem.";
                break;
                
            case 'auth/internal-error':
                message = "Wewnƒôtrzny b≈ÇƒÖd Firebase. Spr√≥buj ponownie za chwilƒô.";
                break;
                
            case 'auth/user-disabled':
                message = "To konto zosta≈Ço zablokowane.";
                break;
                
            default:
                message = `B≈ÇƒÖd logowania: ${error.code || error.message}`;
        }
        
        // Je≈õli popup zosta≈Ç zablokowany, spr√≥buj redirect
        if (shouldTryRedirect) {
            try {
                console.log("üîÑ Pr√≥bujƒô logowanie przez redirect...");
                showLoading('Przekierowanie do Google...');
                await signInWithRedirect(auth, googleProvider);
                // Nie docieramy tutaj - nastƒÖpi przekierowanie
                return;
            } catch (redirectError) {
                console.error("‚ùå B≈ÇƒÖd redirect:", redirectError);
                message = "Nie mo≈ºna zalogowaƒá. Odblokuj popupy dla tej strony i spr√≥buj ponownie.";
            }
        }
        
        showAuthError(message);
        
    } finally {
        isGoogleSignInInProgress = false;
        setGoogleButtonLoading(false);
        hideLoading();
    }
}

// Obs≈Çuga powrotu z redirect (dla urzƒÖdze≈Ñ mobilnych i zablokowanych popup√≥w)
async function handleRedirectResult() {
    try {
        console.log("üîç Sprawdzam wynik redirect...");
        const result = await getRedirectResult(auth);
        
        if (result) {
            console.log("‚úÖ Zalogowano przez Google (redirect):", result.user.email);
            // onAuthStateChanged obs≈Çu≈ºy resztƒô
        } else {
            console.log("‚ÑπÔ∏è Brak wyniku redirect (normalne przy pierwszym ≈Çadowaniu)");
        }
    } catch (error) {
        console.error("‚ùå B≈ÇƒÖd obs≈Çugi redirect:", error.code, error.message);
        
        let message = "B≈ÇƒÖd logowania przez Google. Spr√≥buj ponownie.";
        
        switch(error.code) {
            case 'auth/account-exists-with-different-credential':
                message = "Konto z tym emailem ju≈º istnieje (u≈ºyj innej metody logowania).";
                break;
            case 'auth/credential-already-in-use':
                message = "Te dane logowania sƒÖ ju≈º u≈ºywane przez inne konto.";
                break;
            case 'auth/operation-not-allowed':
                message = "‚ö†Ô∏è Logowanie Google nie jest w≈ÇƒÖczone.";
                break;
        }
        
        showAuthError(message);
    }
}

function showAuthError(message) {
    authError.innerHTML = message;
    authError.classList.remove('hidden');
}

async function setCurrentUser(uid) {
    currentUserID = uid;
    authScreen.style.display = 'none';
    calendarApp.style.display = 'block';
    
    await initCalendarApp();
}

function signOutUser() {
    if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?')) {
        signOut(auth).catch((error) => {
            console.error("B≈ÇƒÖd wylogowania:", error);
            alert("B≈ÇƒÖd wylogowania. Spr√≥buj ponownie.");
        });
    }
}

function unsetCurrentUser() {
    currentUserID = null;
    authScreen.style.display = 'block';
    calendarApp.style.display = 'none';
    
    document.getElementById('auth-email').value = '';
    document.getElementById('auth-password').value = '';
    authError.classList.add('hidden');
}

// --- FIRESTORE LOGIC ---

const getDocRef = () => doc(db, "users", currentUserID);
const getYearField = () => `calendarData.${currentYear}`;


async function loadState() {
    showLoading('≈Åadowanie kalendarza...');
    try {
        const docRef = getDocRef();
        const docSnap = await getDoc(docRef);

        let data = {};
        if (docSnap.exists() && docSnap.data().calendarData && docSnap.data().calendarData[currentYear]) {
            data = docSnap.data().calendarData[currentYear];
        } else {
            console.log(`Brak danych dla roku ${currentYear}. U≈ºycie domy≈õlnych.`);
        }

        targetPercentage = parseFloat(data.targetPercentage) || 0.40;
        officeDays = data.officeDays || [];
        vacationDays = data.vacationDays || [];
        
    } catch (e) {
        console.error("B≈ÇƒÖd ≈Çadowania danych z Firestore: ", e);
        targetPercentage = 0.40;
        officeDays = [];
        vacationDays = [];
    } finally {
        holidaysCache = calculateHolidays(currentYear);
        vacationModes = new Array(12).fill(false);
        hideLoading();
    }
}

async function saveState() {
    const dataToSave = {
        targetPercentage: targetPercentage,
        officeDays: officeDays,
        vacationDays: vacationDays
    };

    try {
        await setDoc(getDocRef(), { 
            calendarData: {
                [currentYear]: dataToSave
            }
        }, { merge: true });

        console.log("Dane zapisane pomy≈õlnie w Firestore dla roku:", currentYear);
        updateYearlyStats();
    } catch (e) {
        console.error("B≈ÇƒÖd zapisu danych do Firestore: ", e);
    }
}

// --- LOGIKA KALENDARZA ---

function getEasterDate(year) {
    const a = year % 19;
    const b = Math.floor(year / 100);
    const c = year % 100;
    const d = Math.floor(b / 4);
    const e = b % 4;
    const f = Math.floor((b + 8) / 25);
    const g = Math.floor((b - f + 1) / 3);
    const h = (19 * a + b - d - g + 15) % 30;
    const i = Math.floor(c / 4);
    const k = c % 4;
    const l = (32 + 2 * e + 2 * i - h - k) % 7;
    const m = Math.floor((a + 11 * h + 22 * l) / 451);
    const p = (h + l - 7 * m + 114);
    const month = Math.floor(p / 31) - 1; 
    const day = (p % 31) + 1;
    return new Date(year, month, day);
}

function addDays(date, days) {
    const result = new Date(date);
    result.setDate(result.getDate() + days);
    return result;
}

function calculateHolidays(year) {
    const h = [];
    h.push(`${year}-01-01`); 
    h.push(`${year}-01-06`); 
    h.push(`${year}-05-01`); 
    h.push(`${year}-05-03`); 
    h.push(`${year}-08-15`); 
    h.push(`${year}-11-01`); 
    h.push(`${year}-11-11`); 
    h.push(`${year}-12-25`); 
    h.push(`${year}-12-26`); 

    const easter = getEasterDate(year);
    const easterMonday = addDays(easter, 1);
    const corpusChristi = addDays(easter, 60); 
    const pentecost = addDays(easter, 49); 

    h.push(formatDate(easter)); 
    h.push(formatDate(easterMonday)); 
    h.push(formatDate(corpusChristi));
    h.push(formatDate(pentecost)); 

    return h;
}

function formatDate(date) {
    const y = date.getFullYear();
    const m = String(date.getMonth() + 1).padStart(2, '0');
    const d = String(date.getDate()).padStart(2, '0');
    return `${y}-${m}-${d}`;
}

function initYearSelector() {
    const selector = document.getElementById('year-selector');
    selector.innerHTML = '';
    for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
        const option = document.createElement('option');
        option.value = y;
        option.text = y;
        if (y === currentYear) option.selected = true;
        selector.appendChild(option);
    }

    document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
    document.getElementById('main-title').setAttribute('data-year', currentYear);
}

async function changeYear(val) {
    currentYear = parseInt(val);
    document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
    document.getElementById('main-title').setAttribute('data-year', currentYear);

    await loadState(); 
    initTargetSelector(); 
    updateYearlyStats();
    renderCalendar();
}

function initTargetSelector() {
    const selector = document.getElementById('target-selector');
    selector.innerHTML = '';
    for (let i = 0; i <= 100; i += 5) {
        const option = document.createElement('option');
        option.value = (i / 100).toFixed(2);
        option.text = i + '%';
        if (Math.abs(parseFloat(option.value) - targetPercentage) < 0.01) {
            option.selected = true;
        }
        selector.appendChild(option);
    }
}

function changeTarget(val) {
    targetPercentage = parseFloat(val);
    saveState();
    updateYearlyStats();
    renderCalendar();
}

function setMode(monthIndex, isVacation) {
    vacationModes[monthIndex] = isVacation;
    renderCalendar();
}

function toggleDay(dateStr, monthIndex) {
    const isVacationMode = vacationModes[monthIndex];
    const date = new Date(dateStr);

    if (isWeekend(date) || (holidaysCache.includes(dateStr) && dateStr !== `${currentYear}-12-24`)) return;

    if (isVacationMode) {
        if (vacationDays.includes(dateStr)) {
            vacationDays = vacationDays.filter(d => d !== dateStr);
        } else {
            vacationDays.push(dateStr);
            officeDays = officeDays.filter(d => d !== dateStr);
        }
    } else {
        if (officeDays.includes(dateStr)) {
            officeDays = officeDays.filter(d => d !== dateStr);
        } else {
            officeDays.push(dateStr);
            vacationDays = vacationDays.filter(d => d !== dateStr);
        }
    }
    saveState(); 
    renderCalendar();
}

function clearAll() {
    if(confirm(`Czy na pewno chcesz wyczy≈õciƒá ca≈Çy kalendarz dla roku ${currentYear}? Spowoduje to usuniƒôcie danych z Twojego konta Firebase.`)) {
        officeDays = [];
        vacationDays = [];
        saveState(); 
        renderCalendar();
    }
}

function isWeekend(date) {
    const day = date.getDay();
    return day === 0 || day === 6; 
}

function getMonthData(monthIndex) {
    const date = new Date(currentYear, monthIndex, 1);
    const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();

    let startDay = date.getDay(); 
    let firstDayOffset = startDay === 0 ? 6 : startDay - 1;

    let days = [];
    let baseWorkingDaysCount = 0; 
    let saturdayHolidayCount = 0;
    let vacationCount = 0; 
    let weekdayHolidayCount = 0; 

    for (let i = 1; i <= daysInMonth; i++) {
        const currentDate = new Date(currentYear, monthIndex, i);
        const dateStr = formatDate(currentDate);
        const _isWeekend = isWeekend(currentDate);
        const dayOfWeek = currentDate.getDay(); 

        const isWigilia = (dateStr === `${currentYear}-12-24`);
        const isRealHoliday = holidaysCache.includes(dateStr) && !isWigilia;
        const isVisualHoliday = holidaysCache.includes(dateStr) || isWigilia;

        const _isOffice = officeDays.includes(dateStr);
        const _isVacation = vacationDays.includes(dateStr);

        if (!_isWeekend) { 
            baseWorkingDaysCount++; 
        }

        if (!_isWeekend && isRealHoliday) {
            weekdayHolidayCount++;
        }

        if (isRealHoliday && dayOfWeek === 6) {
            saturdayHolidayCount++;
        }

        if (!_isWeekend && !isRealHoliday && _isVacation) {
            vacationCount++;
        }

        days.push({
            day: i,
            dateStr: dateStr,
            isWeekend: _isWeekend,
            isHoliday: isVisualHoliday,
            isWigilia: isWigilia,
            isOffice: _isOffice,
            isVacation: _isVacation
        });
    }

    let daysToWorkBase = baseWorkingDaysCount - weekdayHolidayCount;
    daysToWorkBase -= saturdayHolidayCount;

    if (currentYear === 2026 && monthIndex === 11 && daysToWorkBase === 21) {
        daysToWorkBase -= 1; 
    }

    if (daysToWorkBase < 0) daysToWorkBase = 0;

    let effectiveWorkingDays = daysToWorkBase - vacationCount;
    if (effectiveWorkingDays < 0) effectiveWorkingDays = 0;

    const requiredDays = Math.ceil(effectiveWorkingDays * targetPercentage);

    return {
        name: MONTH_NAMES[monthIndex],
        days,
        firstDayOffset,
        effectiveWorkingDays,
        vacationCount,
        requiredDays,
        saturdayHolidayCount
    };
}

function updateYearlyStats() {
    const labelEl = document.getElementById('summary-target-label');
    if (labelEl) labelEl.innerText = Math.round(targetPercentage * 100) + '%';

    let totalEffectiveWorking = 0;
    let totalRequired = 0;

    for(let m=0; m<12; m++) {
        const data = getMonthData(m);
        totalEffectiveWorking += data.effectiveWorkingDays; 
        totalRequired += data.requiredDays;
    }

    const totalSelected = officeDays.length;

    document.getElementById('year-working-days').innerText = totalEffectiveWorking;
    document.getElementById('year-required-days').innerText = totalRequired;

    const selectedEl = document.getElementById('year-selected-days');
    selectedEl.innerText = totalSelected;

    if (totalSelected >= totalRequired) {
        selectedEl.classList.remove('text-slate-700');
        selectedEl.classList.add('text-green-600');
    } else {
        selectedEl.classList.remove('text-green-600');
        selectedEl.classList.add('text-slate-700');
    }
}

function renderCalendar() {
    const container = document.getElementById('calendar-grid');
    container.innerHTML = '';

    for (let m = 0; m < 12; m++) {
        const data = getMonthData(m);
        const currentOfficeCount = data.days.filter(d => d.isOffice).length;
        const isMet = currentOfficeCount >= data.requiredDays;

        const progressPercent = data.requiredDays > 0 ? Math.min(100, (currentOfficeCount / data.requiredDays) * 100) : (data.effectiveWorkingDays === 0 ? 100 : 0);
        const progressColor = isMet ? 'bg-green-500' : 'bg-blue-500';

        const monthCard = document.createElement('div');
        monthCard.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col";

        const isVacationMode = vacationModes[m];

        const btnBase = "flex-1 py-1.5 px-2 rounded text-xs font-semibold transition-colors border flex items-center justify-center gap-1 cursor-pointer select-none";
        const officeBtnClass = !isVacationMode
            ? "bg-blue-600 text-white border-blue-700 shadow-sm ring-1 ring-blue-200"
            : "bg-white text-slate-500 border-slate-200 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200";
        const vacationBtnClass = isVacationMode
            ? "bg-amber-400 text-amber-950 border-amber-500 shadow-sm ring-1 ring-amber-200"
            : "bg-white text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-700 hover:border-amber-300";

        let statusClass = isMet ? "text-green-600 bg-green-50" : "text-slate-500 bg-slate-50";
        let statusIcon = isMet ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : '';

        let noteHtml = '';
        if (data.saturdayHolidayCount > 0) {
            noteHtml = `
            <div class="mx-4 mt-2 px-3 py-2 bg-orange-50 border border-orange-100 rounded-md text-xs text-orange-800 flex items-start">
            <span class="mr-2">‚ÑπÔ∏è</span>
            <span>Zastosowano korektƒô kodeksowƒÖ: odliczono ${data.saturdayHolidayCount} dzie≈Ñ za ≈õwiƒôto w sobotƒô</span>
            </div>
            `;
        }

        if (currentYear === 2026 && m === 11) {
            noteHtml = `
            <div class="mx-4 mt-2 px-3 py-2 bg-yellow-50 border border-yellow-100 rounded-md text-xs text-yellow-800 flex items-start">
            <span class="mr-2">üí°</span>
            <span>Zastosowano korektƒô kodeksowƒÖ: statutowa liczba dni pracujƒÖcych w Grudniu 2026 to 20 (160h).</span>
            </div>
            `;
        }


        let html = `
        <div class="p-4 border-b border-slate-100 flex justify-between items-center ${statusClass}">
        <h2 class="font-bold text-lg">${data.name}</h2>
        <div class="flex items-center gap-1">
        ${statusIcon}
        <span class="text-sm font-semibold">${currentOfficeCount}/${data.requiredDays}</span>
        </div>
        </div>
        
        <div class="w-full h-1.5 bg-slate-100">
        <div class="h-1.5 ${progressColor} transition-all duration-500" style="width: ${progressPercent}%"></div>
        </div>
        
        <div class="px-4 mt-3 flex gap-2 mode-buttons">
        <button onclick="setMode(${m}, false)" class="${btnBase} ${officeBtnClass}">
        üè¢ Biuro
        </button>
        <button onclick="setMode(${m}, true)" class="${btnBase} ${vacationBtnClass}">
        üèñÔ∏è Urlop / L4
        </button>
        </div>

        ${noteHtml}

        <div class="p-4 flex-grow pt-2">
        <div class="flex justify-between text-xs text-slate-400 mb-2 px-1">
        <span title="Dni robocze minus ustawowe ≈õwiƒôta i urlopy (${data.vacationCount} dni)">PracujƒÖce: ${data.effectiveWorkingDays}</span>
        <span>Cel: ${data.requiredDays}</span>
        </div>

        <div class="grid grid-cols-7 gap-1 mb-2 text-center">
        ${DAY_NAMES.map(n => `<div class="text-xs font-bold text-slate-400">${n}</div>`).join('')}
        </div>
        <div class="grid grid-cols-7 gap-1 text-sm">
        `;

        for (let i = 0; i < data.firstDayOffset; i++) {
            html += `<div class="aspect-square"></div>`;
        }

        data.days.forEach(day => {
            let classes = "aspect-square flex items-center justify-center rounded-lg select-none text-sm font-medium day-cell relative ";
            let onclick = "";

            if (day.isHoliday) {
                classes += "bg-red-50 text-red-400 border border-red-100 disabled cursor-not-allowed";
                html += `
                <div class="${classes}" title="${day.isWigilia ? 'Wigilia (opcjonalnie wolne)' : '≈öwiƒôto'}">
                ${day.day}
                <span class="absolute top-0 right-0 w-2 h-2 bg-red-400 rounded-full -mr-0.5 -mt-0.5 opacity-50"></span>
                </div>`;
            } else if (day.isWeekend) {
                classes += "bg-slate-100 text-slate-400 disabled cursor-default";
                html += `<div class="${classes}">${day.day}</div>`;
            } else {
                onclick = `onclick="toggleDay('${day.dateStr}', ${m})"`;

                if (day.isOffice) {
                    classes += "bg-green-500 text-white shadow-md shadow-green-200 border border-green-600";
                } else if (day.isVacation) {
                    classes += "bg-amber-300 text-amber-900 border border-amber-400";
                } else {
                    classes += "bg-white text-slate-700 border border-slate-200 ";
                    if (isVacationMode) {
                        classes += "hover:bg-amber-50 hover:border-amber-300 hover:text-amber-700";
                    } else {
                        classes += "hover:bg-blue-50 hover:border-blue-300 hover:text-blue-700";
                    }
                }
                html += `<div class="${classes}" ${onclick}>${day.day}</div>`;
            }
        });

        html += `
        </div>
        </div>
        `;

        monthCard.innerHTML = html;
        container.appendChild(monthCard);
    }
}

async function initCalendarApp() {
    initYearSelector();
    await loadState(); 
    initTargetSelector();
    updateYearlyStats();
    renderCalendar();
}

// --- INICJALIZACJA PRZY ≈ÅADOWANIU STRONY ---
document.addEventListener('DOMContentLoaded', async () => {
    showLoading('Inicjalizacja...'); 
    
    // Najpierw sprawd≈∫ czy wracamy z redirect (Google login na mobile/zablokowane popupy)
    await handleRedirectResult();
    
    // Nas≈Çuchuj zmian stanu autoryzacji
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            console.log("üë§ U≈ºytkownik zalogowany:", user.email);
            await setCurrentUser(user.uid);
        } else {
            console.log("üë§ U≈ºytkownik wylogowany");
            unsetCurrentUser();
        }
        hideLoading();
    });
});

// --- WA≈ªNE: UDOSTƒòPNIENIE FUNKCJI DLA HTML ---
// Poniewa≈º u≈ºywamy <script type="module">, funkcje domy≈õlnie nie sƒÖ widoczne w globalnym zakresie (window).
// HTML "onclick" szuka funkcji w window. Musimy je przypisaƒá rƒôcznie.

window.handleAuth = handleAuth;
window.toggleAuthMode = toggleAuthMode;
window.signInWithGoogle = signInWithGoogle;
window.signOutUser = signOutUser;
window.changeYear = changeYear;
window.changeTarget = changeTarget;
window.clearAll = clearAll;
window.setMode = setMode;
window.toggleDay = toggleDay;

</script>
</body>
</html>
