<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planer Pracy Hybrydowej</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìÖ</text></svg>">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .day-cell { transition: all 0.15s ease-out; }
        .day-cell:hover:not(.disabled) { transform: scale(1.15); z-index: 10; cursor: pointer; }
        .year-select {
            background: transparent; border: none; color: inherit; font-weight: inherit;
            font-size: inherit; cursor: pointer; border-bottom: 2px solid #bfdbfe;
            padding: 0 0.2em; outline: none; appearance: none; -webkit-appearance: none; text-align: center;
        }
        .year-select:hover { border-bottom-color: #60a5fa; }
        .year-select:focus { background-color: #eff6ff; border-radius: 4px; }
        #calendar-app { display: none; }
        #loading-indicator {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 24px 32px; background: white; border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 1000; display: none;
        }
        #google-auth-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        #google-auth-btn:not(:disabled):hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        #cloud-status {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 12px;
            border-radius: 20px; font-size: 12px; font-weight: 500; transition: all 0.3s ease;
        }
        #cloud-status.saving { background: #dbeafe; color: #1e40af; }
        #cloud-status.saved { background: #dcfce7; color: #166534; }
        #cloud-status.error { background: #fee2e2; color: #991b1b; }
        #cloud-status.loading { background: #f3f4f6; color: #6b7280; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .cloud-saving { animation: pulse 1s infinite; }
        .vacation-limit-input {
            width: 60px; text-align: center; font-weight: bold; color: #d97706;
            background: #fffbeb; border: none; border-bottom: 2px solid #fcd34d;
            padding: 2px 4px; border-radius: 4px; outline: none; transition: all 0.2s;
        }
        .vacation-limit-input:hover { border-bottom-color: #f59e0b; }
        .vacation-limit-input:focus { background: #fef3c7; border-bottom-color: #d97706; }
        .vacation-limit-input::-webkit-outer-spin-button,
        .vacation-limit-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        .vacation-limit-input[type=number] { -moz-appearance: textfield; }
        .limit-warning { animation: shake 0.5s ease-in-out; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

<!-- Wska≈∫nik ≈Çadowania -->
<div id="loading-indicator">
    <div class="text-center">
        <svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-sm text-slate-600" id="loading-text">≈Åadowanie danych...</p>
    </div>
</div>

<!-- Ekran logowania -->
<div id="auth-screen" class="max-w-md mx-auto mt-20 p-8 bg-white rounded-xl shadow-2xl border border-slate-200">
    <h2 class="text-3xl font-bold text-blue-800 mb-2 text-center" id="auth-title">Zaloguj siƒô</h2>
    <p class="text-slate-500 text-sm text-center mb-6">Tw√≥j kalendarz zostanie zapisany w chmurze</p>
    <div id="auth-error" class="text-red-600 mb-4 text-center hidden p-3 bg-red-50 rounded-lg border border-red-200"></div>

    <input type="email" id="auth-email" placeholder="Adres E-mail" class="w-full p-3 mb-4 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">
    <input type="password" id="auth-password" placeholder="Has≈Ço" class="w-full p-3 mb-6 border border-slate-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition">

    <button id="auth-main-btn" onclick="handleAuth()" class="w-full py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed">
        Zaloguj
    </button>

    <div class="mt-4 flex items-center justify-center">
        <div class="w-full border-t border-slate-200"></div>
        <div class="px-3 text-sm text-slate-400">LUB</div>
        <div class="w-full border-t border-slate-200"></div>
    </div>

    <button id="google-auth-btn" onclick="signInWithGoogle()" class="w-full py-3 mt-4 flex items-center justify-center bg-white text-slate-700 font-semibold rounded-lg border border-slate-300 hover:bg-slate-50 transition shadow-sm">
        <svg class="w-5 h-5 mr-2" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
            <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.4l6.62-6.5C34.33 3.6 29.47 2 24 2 15.3 2 7.76 6.13 3.96 12.55l7.98 6.19C13.25 14.54 18.06 9.5 24 9.5z"/>
            <path fill="#4285F4" d="M46.5 24c0-1.64-.15-3.22-.42-4.74H24v9.49h12.7c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6C43.64 38.48 46.5 31.77 46.5 24z"/>
            <path fill="#FBBC05" d="M11.94 28.34c-.63-1.87-.99-3.86-.99-5.91s.36-4.04.99-5.91L3.96 10.33C1.96 14.16 1 18.41 1 23c0 4.59.96 8.84 2.96 12.67l7.98-7.33z"/>
            <path fill="#34A853" d="M24 47c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 40.53 14.54 47 24 47z"/>
        </svg>
        <span id="google-btn-text">Zaloguj przez Google</span>
    </button>

    <p class="text-center mt-6 text-sm">
        <button id="auth-toggle-btn" onclick="toggleAuthMode()" class="text-blue-500 hover:text-blue-700 font-medium">
            Nie masz konta? Zarejestruj siƒô!
        </button>
    </p>
</div>

<!-- Aplikacja kalendarza -->
<div id="calendar-app" class="max-w-7xl mx-auto">
    <header class="mb-8 text-center">
        <div class="flex justify-center items-center gap-3 mb-2 flex-wrap">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-900 flex items-center gap-2 flex-wrap justify-center" id="main-title">
                Kalendarz Pracy Hybrydowej
                <div class="relative inline-block">
                    <select id="year-selector" onchange="changeYear(this.value)" class="year-select text-blue-600">
                    </select>
                </div>
            </h1>
        </div>

        <!-- Status u≈ºytkownika i synchronizacji -->
        <div class="flex justify-center items-center gap-3 mb-4 flex-wrap">
            <span class="text-slate-500 text-sm" id="user-email-display"></span>
            <div id="cloud-status" class="saved">
                <span id="cloud-icon">‚òÅÔ∏è</span>
                <span id="cloud-text">Zapisano</span>
            </div>
        </div>
        
        <div class="text-slate-600 mb-4 flex justify-center items-center gap-4 flex-wrap">
            <p class="flex items-center gap-2">
                Cel: 
                <span class="relative inline-block">
                    <select id="target-selector" onchange="changeTarget(this.value)" class="appearance-none font-bold text-blue-600 bg-blue-50 border-b-2 border-blue-200 hover:border-blue-400 cursor-pointer focus:outline-none focus:bg-blue-100 rounded px-2 py-0.5 text-center transition-all pr-6">
                    </select>
                    <span class="absolute right-1 top-1/2 -translate-y-1/2 pointer-events-none text-blue-400 text-xs">‚ñº</span>
                </span>
                dni w biurze.
            </p>
            <p class="flex items-center gap-2">
                Limit urlopu: 
                <input type="number" id="vacation-limit-input" min="0" max="366" value="26" 
                       onchange="changeVacationLimit(this.value)" 
                       oninput="this.value = this.value.replace(/[^0-9]/g, '')"
                       class="vacation-limit-input">
                <span>dni</span>
            </p>
        </div>

        <div class="flex flex-wrap justify-center gap-4 text-sm bg-white p-3 rounded-xl shadow-sm inline-flex">
            <div class="flex items-center"><div class="w-4 h-4 bg-green-500 rounded mr-2"></div>Biuro</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-amber-400 rounded mr-2"></div>Urlop</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-rose-400 rounded mr-2"></div>L4</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-white border border-slate-300 rounded mr-2"></div>Praca zdalna</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-slate-100 border border-slate-200 rounded mr-2"></div>Weekend</div>
            <div class="flex items-center"><div class="w-4 h-4 bg-red-100 border border-red-200 rounded mr-2"></div>≈öwiƒôto</div>
        </div>

        <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-100 text-sm grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Do przepracowania</div>
                <div class="text-xl font-bold text-slate-700" id="year-working-days">0</div>
                <div class="text-xs text-slate-400 font-normal">(po odjƒôciu nieobecno≈õci)</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Cel (<span id="summary-target-label">40%</span>)</div>
                <div class="text-xl font-bold text-blue-600" id="year-required-days">0</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">W biurze</div>
                <div class="text-xl font-bold text-green-600" id="year-selected-days">0</div>
            </div>
            <div>
                <div class="text-slate-500 text-xs uppercase tracking-wider font-semibold">Nieobecno≈õci</div>
                <div class="text-xl font-bold text-amber-600" id="year-absence-days">0</div>
                <div class="text-xs text-slate-400 font-normal">
                    <span id="vacation-count">0</span>/<span id="vacation-limit-display">26</span> urlop | <span id="sick-count">0</span> L4
                </div>
            </div>
        </div>

        <!-- Ostrze≈ºenie o limicie urlopu -->
        <div id="vacation-limit-warning" class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200 text-sm hidden">
            <div class="flex items-center justify-center gap-2 text-amber-700">
                <span class="text-lg">‚ö†Ô∏è</span>
                <span><strong>OsiƒÖgniƒôto limit urlopu!</strong> Wykorzystano <span id="vacation-used">0</span> z <span id="vacation-max">26</span> dni.</span>
            </div>
        </div>

        <div class="mt-4 text-sm text-slate-400 text-center flex flex-wrap justify-center gap-4">
            <button onclick="clearAll()" class="text-red-400 hover:text-red-600 underline text-xs">
                üóëÔ∏è Zresetuj rok <span class="current-year-display"></span>
            </button>
            <button onclick="signOutUser()" class="text-slate-400 hover:text-slate-600 underline text-xs">
                üö™ Wyloguj
            </button>
        </div>
    </header>

    <div id="calendar-grid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
    </div>

    <footer class="mt-12 text-center text-slate-400 text-sm pb-8">
        ‚òÅÔ∏è Twoje dane sƒÖ automatycznie zapisywane w chmurze Firebase.<br>
        Po ponownym zalogowaniu zobaczysz sw√≥j kalendarz w ostatnim zapisanym stanie.
    </footer>
</div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, GoogleAuthProvider, signInWithPopup, signInWithRedirect, getRedirectResult } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js';
    import { getFirestore, doc, getDoc, setDoc } from 'https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js';

    // --- KONFIGURACJA FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyAV5MvDejW_cefwyx-ZeBKqWcjUveyYEs0",
        authDomain: "hybridworker.firebaseapp.com",
        projectId: "hybridworker",
        storageBucket: "hybridworker.firebasestorage.app",
        messagingSenderId: "1077197503232",
        appId: "1:1077197503232:web:e22cf7b58264024bb051e5",
        measurementId: "G-T8T1JM3RMS"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const googleProvider = new GoogleAuthProvider();
    googleProvider.addScope('email');
    googleProvider.addScope('profile');
    googleProvider.setCustomParameters({ prompt: 'select_account' });

    // --- STA≈ÅE I ZMIENNE ---
    const MIN_YEAR = 2025;
    const MAX_YEAR = 2035;
    const nowYear = new Date().getFullYear();
    let currentYear = (nowYear >= MIN_YEAR && nowYear <= MAX_YEAR) ? nowYear : MIN_YEAR;
    let targetPercentage = 0.40;
    let vacationDaysLimit = 26;
    let holidaysCache = [];

    const MONTH_NAMES = ["Stycze≈Ñ", "Luty", "Marzec", "Kwiecie≈Ñ", "Maj", "Czerwiec", "Lipiec", "Sierpie≈Ñ", "Wrzesie≈Ñ", "Pa≈∫dziernik", "Listopad", "Grudzie≈Ñ"];
    const DAY_NAMES = ["Pn", "Wt", "≈ör", "Cz", "Pt", "Sb", "Nd"];

    const HOLIDAY_NAMES = {
        '01-01': 'Nowy Rok',
        '01-06': 'Trzech Kr√≥li',
        '05-01': '≈öwiƒôto Pracy',
        '05-03': '≈öwiƒôto Konstytucji 3 Maja',
        '08-15': 'Wniebowziƒôcie NMP',
        '11-01': 'Wszystkich ≈öwiƒôtych',
        '11-11': '≈öwiƒôto Niepodleg≈Ço≈õci',
        '12-25': 'Bo≈ºe Narodzenie',
        '12-26': 'Drugi dzie≈Ñ Bo≈ºego Narodzenia'
    };

    const MODE_OFFICE = 'office';
    const MODE_VACATION = 'vacation';
    const MODE_SICK = 'sick';

    let officeDays = [];
    let vacationDays = [];
    let sickLeaveDays = [];
    let monthModes = new Array(12).fill(MODE_OFFICE);
    let isLoginMode = true;
    let currentUserID = null;
    let currentUserEmail = null;
    let isGoogleSignInInProgress = false;
    let saveTimeout = null;
    let isSaving = false;

    // --- ELEMENTY DOM ---
    const authScreen = document.getElementById('auth-screen');
    const calendarApp = document.getElementById('calendar-app');
    const authTitle = document.getElementById('auth-title');
    const authMainBtn = document.getElementById('auth-main-btn');
    const authToggleBtn = document.getElementById('auth-toggle-btn');
    const authError = document.getElementById('auth-error');
    const googleAuthBtn = document.getElementById('google-auth-btn');
    const googleBtnText = document.getElementById('google-btn-text');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadingText = document.getElementById('loading-text');
    const userEmailDisplay = document.getElementById('user-email-display');
    const cloudStatus = document.getElementById('cloud-status');
    const cloudIcon = document.getElementById('cloud-icon');
    const cloudText = document.getElementById('cloud-text');
    const vacationLimitInput = document.getElementById('vacation-limit-input');
    const vacationLimitWarning = document.getElementById('vacation-limit-warning');

    // --- FUNKCJE POMOCNICZE ---
    function showLoading(text = '≈Åadowanie...') {
        loadingText.textContent = text;
        loadingIndicator.style.display = 'block';
    }

    function hideLoading() {
        loadingIndicator.style.display = 'none';
    }

    function updateCloudStatus(status) {
        cloudStatus.className = status;
        cloudIcon.className = '';
        switch(status) {
            case 'saving':
                cloudIcon.textContent = '‚òÅÔ∏è';
                cloudIcon.className = 'cloud-saving';
                cloudText.textContent = 'Zapisywanie...';
                break;
            case 'saved':
                cloudIcon.textContent = '‚úÖ';
                cloudText.textContent = 'Zapisano w chmurze';
                break;
            case 'error':
                cloudIcon.textContent = '‚ùå';
                cloudText.textContent = 'B≈ÇƒÖd zapisu';
                break;
            case 'loading':
                cloudIcon.textContent = 'üîÑ';
                cloudText.textContent = '≈Åadowanie...';
                break;
        }
    }

    function setGoogleButtonLoading(isLoading) {
        googleAuthBtn.disabled = isLoading;
        googleBtnText.textContent = isLoading ? 'Logowanie...' : 'Zaloguj przez Google';
        googleAuthBtn.classList.toggle('opacity-70', isLoading);
    }

    function showVacationLimitWarning() {
        vacationLimitInput.classList.add('limit-warning');
        setTimeout(() => vacationLimitInput.classList.remove('limit-warning'), 500);
    }

    function getTotalVacationDays() {
        let total = 0;
        for (let m = 0; m < 12; m++) {
            const data = getMonthData(m);
            total += data.vacationCount;
        }
        return total;
    }

    // --- AUTORYZACJA ---
    function toggleAuthMode() {
        isLoginMode = !isLoginMode;
        authTitle.innerText = isLoginMode ? "Zaloguj siƒô" : "Zarejestruj siƒô";
        authMainBtn.innerText = isLoginMode ? "Zaloguj" : "Zarejestruj";
        authToggleBtn.innerText = isLoginMode ? "Nie masz konta? Zarejestruj siƒô!" : "Masz ju≈º konto? Zaloguj siƒô!";
        authError.classList.add('hidden');
    }

    async function handleAuth() {
        const email = document.getElementById('auth-email').value;
        const password = document.getElementById('auth-password').value;
        authError.classList.add('hidden');
        authMainBtn.disabled = true;

        if (!email || !password) {
            showAuthError("Wype≈Çnij oba pola.");
            authMainBtn.disabled = false;
            return;
        }

        showLoading(isLoginMode ? 'Logowanie...' : 'Rejestracja...');

        try {
            if (isLoginMode) {
                await signInWithEmailAndPassword(auth, email, password);
            } else {
                await createUserWithEmailAndPassword(auth, email, password);
            }
        } catch (error) {
            console.error("B≈ÇƒÖd autoryzacji:", error.code);
            let message = "WystƒÖpi≈Ç b≈ÇƒÖd. Spr√≥buj ponownie.";
            switch(error.code) {
                case 'auth/wrong-password':
                case 'auth/user-not-found':
                case 'auth/invalid-credential':
                    message = "Nieprawid≈Çowy e-mail lub has≈Ço.";
                    break;
                case 'auth/email-already-in-use':
                    message = "Ten e-mail jest ju≈º zajƒôty.";
                    break;
                case 'auth/weak-password':
                    message = "Has≈Ço musi mieƒá co najmniej 6 znak√≥w.";
                    break;
                case 'auth/invalid-email':
                    message = "Nieprawid≈Çowy format e-mail.";
                    break;
                case 'auth/too-many-requests':
                    message = "Zbyt wiele pr√≥b. Poczekaj chwilƒô.";
                    break;
                case 'auth/network-request-failed':
                    message = "B≈ÇƒÖd sieci.";
                    break;
            }
            showAuthError(message);
        } finally {
            authMainBtn.disabled = false;
            hideLoading();
        }
    }

    async function signInWithGoogle() {
        if (isGoogleSignInInProgress) return;
        isGoogleSignInInProgress = true;
        authError.classList.add('hidden');
        setGoogleButtonLoading(true);

        try {
            await signInWithPopup(auth, googleProvider);
        } catch (error) {
            console.error("B≈ÇƒÖd Google Auth:", error.code);
            let message = "B≈ÇƒÖd logowania przez Google.";
            let shouldTryRedirect = false;

            switch(error.code) {
                case 'auth/popup-closed-by-user':
                    message = "Okno zamkniƒôte. Spr√≥buj ponownie.";
                    break;
                case 'auth/popup-blocked':
                    shouldTryRedirect = true;
                    break;
                case 'auth/operation-not-allowed':
                    message = "Google Auth nie jest w≈ÇƒÖczone.";
                    break;
                case 'auth/network-request-failed':
                    message = "B≈ÇƒÖd sieci.";
                    break;
            }

            if (shouldTryRedirect) {
                try {
                    showLoading('Przekierowanie...');
                    await signInWithRedirect(auth, googleProvider);
                    return;
                } catch (e) {
                    message = "Odblokuj popupy i spr√≥buj ponownie.";
                }
            }
            showAuthError(message);
        } finally {
            isGoogleSignInInProgress = false;
            setGoogleButtonLoading(false);
            hideLoading();
        }
    }

    async function handleRedirectResult() {
        try {
            const result = await getRedirectResult(auth);
            if (result) {
                console.log("‚úÖ Zalogowano przez redirect");
            }
        } catch (error) {
            console.error("B≈ÇƒÖd redirect:", error);
            showAuthError("B≈ÇƒÖd logowania. Spr√≥buj ponownie.");
        }
    }

    function showAuthError(message) {
        authError.innerHTML = message;
        authError.classList.remove('hidden');
    }

    async function setCurrentUser(user) {
        currentUserID = user.uid;
        currentUserEmail = user.email;
        authScreen.style.display = 'none';
        calendarApp.style.display = 'block';
        userEmailDisplay.textContent = currentUserEmail;
        await initCalendarApp();
    }

    function signOutUser() {
        if (confirm('Czy na pewno chcesz siƒô wylogowaƒá?\nTwoje dane sƒÖ bezpiecznie zapisane w chmurze.')) {
            signOut(auth).catch((error) => {
                console.error("B≈ÇƒÖd wylogowania:", error);
            });
        }
    }

    function unsetCurrentUser() {
        currentUserID = null;
        currentUserEmail = null;
        authScreen.style.display = 'block';
        calendarApp.style.display = 'none';
        officeDays = [];
        vacationDays = [];
        sickLeaveDays = [];
        document.getElementById('auth-email').value = '';
        document.getElementById('auth-password').value = '';
        authError.classList.add('hidden');
    }

    // --- FIREBASE FIRESTORE ---
    function getDocRef() {
        return doc(db, "users", currentUserID);
    }

    async function loadState() {
        updateCloudStatus('loading');
        showLoading('≈Åadowanie Twojego kalendarza...');

        try {
            const docRef = getDocRef();
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const userData = docSnap.data();
                if (userData.calendarData && userData.calendarData[currentYear]) {
                    const yearData = userData.calendarData[currentYear];
                    targetPercentage = parseFloat(yearData.targetPercentage) || 0.40;
                    vacationDaysLimit = parseInt(yearData.vacationDaysLimit) || 26;
                    officeDays = yearData.officeDays || [];
                    vacationDays = yearData.vacationDays || [];
                    sickLeaveDays = yearData.sickLeaveDays || [];
                    console.log(`‚úÖ Za≈Çadowano dane dla roku ${currentYear}`);
                } else {
                    console.log(`‚ÑπÔ∏è Brak danych dla roku ${currentYear}`);
                    resetToDefaults();
                }
            } else {
                console.log("‚ÑπÔ∏è Nowy u≈ºytkownik");
                resetToDefaults();
                await saveState();
            }
            updateCloudStatus('saved');
        } catch (e) {
            console.error("‚ùå B≈ÇƒÖd ≈Çadowania:", e);
            updateCloudStatus('error');
            resetToDefaults();
        } finally {
            holidaysCache = calculateHolidays(currentYear);
            monthModes = new Array(12).fill(MODE_OFFICE);
            hideLoading();
        }
    }

    function resetToDefaults() {
        targetPercentage = 0.40;
        vacationDaysLimit = 26;
        officeDays = [];
        vacationDays = [];
        sickLeaveDays = [];
    }

    async function saveState() {
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }

        updateCloudStatus('saving');

        saveTimeout = setTimeout(async () => {
            if (isSaving) return;
            isSaving = true;

            const dataToSave = {
                targetPercentage: targetPercentage,
                vacationDaysLimit: vacationDaysLimit,
                officeDays: [...officeDays],
                vacationDays: [...vacationDays],
                sickLeaveDays: [...sickLeaveDays],
                lastUpdated: new Date().toISOString()
            };

            try {
                await setDoc(getDocRef(), {
                    email: currentUserEmail,
                    lastLogin: new Date().toISOString(),
                    calendarData: {
                        [currentYear]: dataToSave
                    }
                }, { merge: true });

                console.log(`‚úÖ Zapisano w Firebase dla roku ${currentYear}`);
                updateCloudStatus('saved');
            } catch (e) {
                console.error("‚ùå B≈ÇƒÖd zapisu:", e);
                updateCloudStatus('error');
            } finally {
                isSaving = false;
            }
        }, 800);
    }

    // --- LOGIKA KALENDARZA ---
    function getEasterDate(year) {
        const a = year % 19;
        const b = Math.floor(year / 100);
        const c = year % 100;
        const d = Math.floor(b / 4);
        const e = b % 4;
        const f = Math.floor((b + 8) / 25);
        const g = Math.floor((b - f + 1) / 3);
        const h = (19 * a + b - d - g + 15) % 30;
        const i = Math.floor(c / 4);
        const k = c % 4;
        const l = (32 + 2 * e + 2 * i - h - k) % 7;
        const m = Math.floor((a + 11 * h + 22 * l) / 451);
        const p = (h + l - 7 * m + 114);
        const month = Math.floor(p / 31) - 1;
        const day = (p % 31) + 1;
        return new Date(year, month, day);
    }

    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function calculateHolidays(year) {
        const h = [
            `${year}-01-01`, `${year}-01-06`, `${year}-05-01`, `${year}-05-03`,
            `${year}-08-15`, `${year}-11-01`, `${year}-11-11`, `${year}-12-25`, `${year}-12-26`
        ];
        const easter = getEasterDate(year);
        h.push(formatDate(easter));
        h.push(formatDate(addDays(easter, 1)));
        h.push(formatDate(addDays(easter, 49)));
        h.push(formatDate(addDays(easter, 60)));
        return h;
    }

    function getMovingHolidayName(dateStr, year) {
        const easter = getEasterDate(year);
        const easterStr = formatDate(easter);
        const easterMondayStr = formatDate(addDays(easter, 1));
        const pentecostStr = formatDate(addDays(easter, 49));
        const corpusChristiStr = formatDate(addDays(easter, 60));

        if (dateStr === easterStr) return 'Wielkanoc';
        if (dateStr === easterMondayStr) return 'Poniedzia≈Çek Wielkanocny';
        if (dateStr === pentecostStr) return 'Zes≈Çanie Ducha ≈öwiƒôtego';
        if (dateStr === corpusChristiStr) return 'Bo≈ºe Cia≈Ço';
        return '≈öwiƒôto';
    }

    function formatDate(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function isWeekend(date) {
        const day = date.getDay();
        return day === 0 || day === 6;
    }

    function initYearSelector() {
        const selector = document.getElementById('year-selector');
        selector.innerHTML = '';
        for (let y = MIN_YEAR; y <= MAX_YEAR; y++) {
            const option = document.createElement('option');
            option.value = y;
            option.text = y;
            if (y === currentYear) option.selected = true;
            selector.appendChild(option);
        }
        document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
    }

    async function changeYear(val) {
        currentYear = parseInt(val);
        document.querySelectorAll('.current-year-display').forEach(el => el.innerText = currentYear);
        await loadState();
        initTargetSelector();
        updateVacationLimitInput();
        updateYearlyStats();
        renderCalendar();
    }

    function initTargetSelector() {
        const selector = document.getElementById('target-selector');
        selector.innerHTML = '';
        for (let i = 0; i <= 100; i += 5) {
            const option = document.createElement('option');
            option.value = (i / 100).toFixed(2);
            option.text = i + '%';
            if (Math.abs(parseFloat(option.value) - targetPercentage) < 0.01) {
                option.selected = true;
            }
            selector.appendChild(option);
        }
    }

    function updateVacationLimitInput() {
        vacationLimitInput.value = vacationDaysLimit;
    }

    function changeTarget(val) {
        targetPercentage = parseFloat(val);
        saveState();
        updateYearlyStats();
        renderCalendar();
    }

    function changeVacationLimit(val) {
        const newLimit = parseInt(val) || 0;
        if (newLimit < 0) {
            vacationLimitInput.value = 0;
            vacationDaysLimit = 0;
        } else if (newLimit > 366) {
            vacationLimitInput.value = 366;
            vacationDaysLimit = 366;
        } else {
            vacationDaysLimit = newLimit;
        }
        saveState();
        updateYearlyStats();
        renderCalendar();
    }

    function setMode(monthIndex, mode) {
        monthModes[monthIndex] = mode;
        renderCalendar();
    }

    function toggleDay(dateStr, monthIndex) {
        const currentMode = monthModes[monthIndex];
        const date = new Date(dateStr);

        if (isWeekend(date) || (holidaysCache.includes(dateStr) && dateStr !== `${currentYear}-12-24`)) return;

        const removeFromAll = () => {
            officeDays = officeDays.filter(d => d !== dateStr);
            vacationDays = vacationDays.filter(d => d !== dateStr);
            sickLeaveDays = sickLeaveDays.filter(d => d !== dateStr);
        };

        if (currentMode === MODE_OFFICE) {
            if (officeDays.includes(dateStr)) {
                officeDays = officeDays.filter(d => d !== dateStr);
            } else {
                removeFromAll();
                officeDays.push(dateStr);
            }
        } else if (currentMode === MODE_VACATION) {
            if (vacationDays.includes(dateStr)) {
                vacationDays = vacationDays.filter(d => d !== dateStr);
            } else {
                // Sprawd≈∫ limit urlopu przed dodaniem
                const currentVacationCount = getTotalVacationDays();
                if (currentVacationCount >= vacationDaysLimit) {
                    showVacationLimitWarning();
                    return;
                }
                removeFromAll();
                vacationDays.push(dateStr);
            }
        } else if (currentMode === MODE_SICK) {
            if (sickLeaveDays.includes(dateStr)) {
                sickLeaveDays = sickLeaveDays.filter(d => d !== dateStr);
            } else {
                removeFromAll();
                sickLeaveDays.push(dateStr);
            }
        }

        saveState();
        updateYearlyStats();
        renderCalendar();
    }

    function clearAll() {
        if(confirm(`Wyczy≈õciƒá wszystkie zaznaczenia dla roku ${currentYear}?\n\nTa operacja usunie wszystkie dni biurowe, urlopy i L4.`)) {
            officeDays = [];
            vacationDays = [];
            sickLeaveDays = [];
            saveState();
            updateYearlyStats();
            renderCalendar();
        }
    }

    function getMonthData(monthIndex) {
        const daysInMonth = new Date(currentYear, monthIndex + 1, 0).getDate();
        let startDay = new Date(currentYear, monthIndex, 1).getDay();
        let firstDayOffset = startDay === 0 ? 6 : startDay - 1;

        let days = [];
        let baseWorkingDaysCount = 0;
        let vacationCount = 0;
        let sickLeaveCount = 0;
        let weekdayHolidayCount = 0;

        for (let i = 1; i <= daysInMonth; i++) {
            const currentDate = new Date(currentYear, monthIndex, i);
            const dateStr = formatDate(currentDate);
            const _isWeekend = isWeekend(currentDate);
            const isWigilia = (dateStr === `${currentYear}-12-24`);
            const isRealHoliday = holidaysCache.includes(dateStr) && !isWigilia;
            const isVisualHoliday = holidaysCache.includes(dateStr) || isWigilia;
            const _isOffice = officeDays.includes(dateStr);
            const _isVacation = vacationDays.includes(dateStr);
            const _isSickLeave = sickLeaveDays.includes(dateStr);

            if (!_isWeekend) baseWorkingDaysCount++;
            if (!_isWeekend && isRealHoliday) weekdayHolidayCount++;
            if (!_isWeekend && !isRealHoliday && _isVacation) vacationCount++;
            if (!_isWeekend && !isRealHoliday && _isSickLeave) sickLeaveCount++;

            days.push({
                day: i, dateStr, isWeekend: _isWeekend, isHoliday: isVisualHoliday,
                isWigilia, isOffice: _isOffice, isVacation: _isVacation, isSickLeave: _isSickLeave
            });
        }

        let daysToWorkBase = baseWorkingDaysCount - weekdayHolidayCount;
        if (daysToWorkBase < 0) daysToWorkBase = 0;

        let effectiveWorkingDays = daysToWorkBase - vacationCount - sickLeaveCount;
        if (effectiveWorkingDays < 0) effectiveWorkingDays = 0;

        const requiredDays = Math.ceil(effectiveWorkingDays * targetPercentage);

        return { name: MONTH_NAMES[monthIndex], days, firstDayOffset, effectiveWorkingDays, vacationCount, sickLeaveCount, requiredDays };
    }

    function updateYearlyStats() {
        document.getElementById('summary-target-label').innerText = Math.round(targetPercentage * 100) + '%';

        let totalEffectiveWorking = 0;
        let totalRequired = 0;
        let totalVacation = 0;
        let totalSick = 0;

        for (let m = 0; m < 12; m++) {
            const data = getMonthData(m);
            totalEffectiveWorking += data.effectiveWorkingDays;
            totalRequired += data.requiredDays;
            totalVacation += data.vacationCount;
            totalSick += data.sickLeaveCount;
        }

        document.getElementById('year-working-days').innerText = totalEffectiveWorking;
        document.getElementById('year-required-days').innerText = totalRequired;
        document.getElementById('year-absence-days').innerText = totalVacation + totalSick;
        document.getElementById('vacation-count').innerText = totalVacation;
        document.getElementById('vacation-limit-display').innerText = vacationDaysLimit;
        document.getElementById('sick-count').innerText = totalSick;

        // Aktualizuj ostrze≈ºenie o limicie urlopu
        const vacationUsed = document.getElementById('vacation-used');
        const vacationMax = document.getElementById('vacation-max');
        
        if (vacationUsed && vacationMax) {
            vacationUsed.textContent = totalVacation;
            vacationMax.textContent = vacationDaysLimit;
        }

        if (totalVacation >= vacationDaysLimit && vacationDaysLimit > 0) {
            vacationLimitWarning.classList.remove('hidden');
        } else {
            vacationLimitWarning.classList.add('hidden');
        }

        const selectedEl = document.getElementById('year-selected-days');
        selectedEl.innerText = officeDays.length;

        if (officeDays.length >= totalRequired) {
            selectedEl.classList.remove('text-slate-700');
            selectedEl.classList.add('text-green-600');
        } else {
            selectedEl.classList.remove('text-green-600');
            selectedEl.classList.add('text-slate-700');
        }
    }

    function renderCalendar() {
        const container = document.getElementById('calendar-grid');
        container.innerHTML = '';

        for (let m = 0; m < 12; m++) {
            const data = getMonthData(m);
            const currentOfficeCount = data.days.filter(d => d.isOffice).length;
            const isMet = currentOfficeCount >= data.requiredDays;
            const progressPercent = data.requiredDays > 0 ? Math.min(100, (currentOfficeCount / data.requiredDays) * 100) : 100;
            const progressColor = isMet ? 'bg-green-500' : 'bg-blue-500';
            const currentMode = monthModes[m];

            const monthCard = document.createElement('div');
            monthCard.className = "bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col";

            const btnBase = "py-1.5 px-2 rounded text-xs font-semibold transition-all border flex items-center justify-center gap-1 cursor-pointer select-none flex-1";
            const officeBtnClass = currentMode === MODE_OFFICE ? "bg-green-600 text-white border-green-700 shadow-sm" : "bg-white text-slate-500 border-slate-200 hover:bg-green-50 hover:text-green-600";
            const vacationBtnClass = currentMode === MODE_VACATION ? "bg-amber-500 text-white border-amber-600 shadow-sm" : "bg-white text-slate-500 border-slate-200 hover:bg-amber-50 hover:text-amber-600";
            const sickBtnClass = currentMode === MODE_SICK ? "bg-rose-500 text-white border-rose-600 shadow-sm" : "bg-white text-slate-500 border-slate-200 hover:bg-rose-50 hover:text-rose-600";

            let statusClass = isMet ? "text-green-600 bg-green-50" : "text-slate-500 bg-slate-50";
            let statusIcon = isMet ? `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>` : '';

            let absenceSummary = '';
            if (data.vacationCount > 0 || data.sickLeaveCount > 0) {
                const parts = [];
                if (data.vacationCount > 0) parts.push(`${data.vacationCount}u`);
                if (data.sickLeaveCount > 0) parts.push(`${data.sickLeaveCount}L4`);
                absenceSummary = `<span class="text-amber-600">(${parts.join('/')})</span>`;
            }

            let html = `
                <div class="p-4 border-b border-slate-100 ${statusClass}">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="font-bold text-lg">${data.name}</h2>
                        <div class="flex items-center gap-1">
                            ${statusIcon}
                            <span class="text-sm font-semibold">${currentOfficeCount}/${data.requiredDays}</span>
                        </div>
                    </div>
                    <div class="flex gap-2 mode-buttons">
                        <button onclick="setMode(${m}, '${MODE_OFFICE}')" class="${btnBase} ${officeBtnClass}">üè¢ Biuro</button>
                        <button onclick="setMode(${m}, '${MODE_VACATION}')" class="${btnBase} ${vacationBtnClass}">üèñÔ∏è Urlop</button>
                        <button onclick="setMode(${m}, '${MODE_SICK}')" class="${btnBase} ${sickBtnClass}">üè• L4</button>
                    </div>
                </div>
                <div class="w-full h-1.5 bg-slate-100">
                    <div class="h-1.5 ${progressColor} transition-all duration-500" style="width: ${progressPercent}%"></div>
                </div>
                <div class="p-4 flex-grow pt-2">
                    <div class="flex justify-between text-xs text-slate-400 mb-2 px-1">
                        <span>PracujƒÖce: ${data.effectiveWorkingDays} ${absenceSummary}</span>
                        <span>Cel: ${data.requiredDays}</span>
                    </div>
                    <div class="grid grid-cols-7 gap-1 mb-2 text-center">
                        ${DAY_NAMES.map(n => `<div class="text-xs font-bold text-slate-400">${n}</div>`).join('')}
                    </div>
                    <div class="grid grid-cols-7 gap-1 text-sm">
            `;

            for (let i = 0; i < data.firstDayOffset; i++) {
                html += `<div class="aspect-square"></div>`;
            }

            data.days.forEach(day => {
                let classes = "aspect-square flex items-center justify-center rounded-lg select-none text-sm font-medium day-cell relative ";
                let onclick = "";
                let title = "";

                if (day.isHoliday) {
                    classes += "bg-red-50 text-red-400 border border-red-100 disabled cursor-not-allowed";
                    const monthDay = day.dateStr.slice(5);
                    title = day.isWigilia ? 'Wigilia' : (HOLIDAY_NAMES[monthDay] || getMovingHolidayName(day.dateStr, currentYear));
                    html += `<div class="${classes}" title="${title}">${day.day}<span class="absolute top-0 right-0 w-2 h-2 bg-red-400 rounded-full -mr-0.5 -mt-0.5 opacity-50"></span></div>`;
                } else if (day.isWeekend) {
                    classes += "bg-slate-100 text-slate-400 disabled cursor-default";
                    html += `<div class="${classes}">${day.day}</div>`;
                } else {
                    onclick = `onclick="toggleDay('${day.dateStr}', ${m})"`;
                    if (day.isOffice) {
                        classes += "bg-green-500 text-white shadow-md shadow-green-200 border border-green-600";
                        title = "Dzie≈Ñ w biurze";
                    } else if (day.isVacation) {
                        classes += "bg-amber-400 text-white shadow-md shadow-amber-200 border border-amber-500";
                        title = "Urlop";
                    } else if (day.isSickLeave) {
                        classes += "bg-rose-400 text-white shadow-md shadow-rose-200 border border-rose-500";
                        title = "Zwolnienie lekarskie (L4)";
                    } else {
                        classes += "bg-white text-slate-700 border border-slate-200 ";
                        if (currentMode === MODE_VACATION) {
                            classes += "hover:bg-amber-50 hover:border-amber-300";
                        } else if (currentMode === MODE_SICK) {
                            classes += "hover:bg-rose-50 hover:border-rose-300";
                        } else {
                            classes += "hover:bg-green-50 hover:border-green-300";
                        }
                        title = "Praca zdalna (kliknij aby zmieniƒá)";
                    }
                    html += `<div class="${classes}" ${onclick} title="${title}">${day.day}</div>`;
                }
            });

            html += `</div></div>`;
            monthCard.innerHTML = html;
            container.appendChild(monthCard);
        }
    }

    async function initCalendarApp() {
        initYearSelector();
        await loadState();
        initTargetSelector();
        updateVacationLimitInput();
        updateYearlyStats();
        renderCalendar();
    }

    // --- INICJALIZACJA ---
    document.addEventListener('DOMContentLoaded', async () => {
        showLoading('Inicjalizacja...');
        await handleRedirectResult();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("üë§ Zalogowano:", user.email);
                await setCurrentUser(user);
            } else {
                console.log("üë§ Wylogowano");
                unsetCurrentUser();
            }
            hideLoading();
        });
    });

    // --- GLOBAL ---
    window.handleAuth = handleAuth;
    window.toggleAuthMode = toggleAuthMode;
    window.signInWithGoogle = signInWithGoogle;
    window.signOutUser = signOutUser;
    window.changeYear = changeYear;
    window.changeTarget = changeTarget;
    window.changeVacationLimit = changeVacationLimit;
    window.clearAll = clearAll;
    window.setMode = setMode;
    window.toggleDay = toggleDay;
</script>
</body>
</html>
